(()=>{var J=Object.defineProperty,Q=Object.defineProperties;var X=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var Z=Object.prototype.hasOwnProperty,ee=Object.prototype.propertyIsEnumerable;var A=(e,t,s)=>t in e?J(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,v=(e,t)=>{for(var s in t||(t={}))Z.call(t,s)&&A(e,s,t[s]);if(S)for(var s of S(t))ee.call(t,s)&&A(e,s,t[s]);return e},L=(e,t)=>Q(e,X(t));var f=(e,t,s)=>new Promise((n,a)=>{var o=i=>{try{d(s.next(i))}catch(l){a(l)}},r=i=>{try{d(s.throw(i))}catch(l){a(l)}},d=i=>i.done?n(i.value):Promise.resolve(i.value).then(o,r);d((s=s.apply(e,t)).next())});var te=(e,t)=>t.some(s=>e instanceof s),R,P;function se(){return R||(R=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function ne(){return P||(P=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var k=new WeakMap,w=new WeakMap,q=new WeakMap,y=new WeakMap,I=new WeakMap;function ae(e){let t=new Promise((s,n)=>{let a=()=>{e.removeEventListener("success",o),e.removeEventListener("error",r)},o=()=>{s(b(e.result)),a()},r=()=>{n(e.error),a()};e.addEventListener("success",o),e.addEventListener("error",r)});return t.then(s=>{s instanceof IDBCursor&&k.set(s,e)}).catch(()=>{}),I.set(t,e),t}function re(e){if(w.has(e))return;let t=new Promise((s,n)=>{let a=()=>{e.removeEventListener("complete",o),e.removeEventListener("error",r),e.removeEventListener("abort",r)},o=()=>{s(),a()},r=()=>{n(e.error||new DOMException("AbortError","AbortError")),a()};e.addEventListener("complete",o),e.addEventListener("error",r),e.addEventListener("abort",r)});w.set(e,t)}var _={get(e,t,s){if(e instanceof IDBTransaction){if(t==="done")return w.get(e);if(t==="objectStoreNames")return e.objectStoreNames||q.get(e);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return b(e[t])},set(e,t,s){return e[t]=s,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function N(e){_=e(_)}function oe(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...s){let n=e.call(C(this),t,...s);return q.set(n,t.sort?t.sort():[t]),b(n)}:ne().includes(e)?function(...t){return e.apply(C(this),t),b(k.get(this))}:function(...t){return b(e.apply(C(this),t))}}function ie(e){return typeof e=="function"?oe(e):(e instanceof IDBTransaction&&re(e),te(e,se())?new Proxy(e,_):e)}function b(e){if(e instanceof IDBRequest)return ae(e);if(y.has(e))return y.get(e);let t=ie(e);return t!==e&&(y.set(e,t),I.set(t,e)),t}var C=e=>I.get(e);function F(e,t,{blocked:s,upgrade:n,blocking:a,terminated:o}={}){let r=indexedDB.open(e,t),d=b(r);return n&&r.addEventListener("upgradeneeded",i=>{n(b(r.result),i.oldVersion,i.newVersion,b(r.transaction))}),s&&r.addEventListener("blocked",()=>s()),d.then(i=>{o&&i.addEventListener("close",()=>o()),a&&i.addEventListener("versionchange",()=>a())}).catch(()=>{}),d}var de=["get","getKey","getAll","getAllKeys","count"],ce=["put","add","delete","clear"],B=new Map;function j(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(B.get(t))return B.get(t);let s=t.replace(/FromIndex$/,""),n=t!==s,a=ce.includes(s);if(!(s in(n?IDBIndex:IDBObjectStore).prototype)||!(a||de.includes(s)))return;let o=async function(r,...d){let i=this.transaction(r,a?"readwrite":"readonly"),l=i.store;return n&&(l=l.index(d.shift())),(await Promise.all([l[s](...d),a&&i.done]))[0]};return B.set(t,o),o}N(e=>({...e,get:(t,s,n)=>j(t,s)||e.get(t,s,n),has:(t,s)=>!!j(t,s)||e.has(t,s)}));var O=new Map,M=class{constructor(e,t){this.type="reqRep",this.settings={},this.name="",this.name=e,this.settings=t}async request(e){return c.Request(this.name,e,this.settings.enableBroadcast)}reply(e){return c.Reply(this.name,e,this.settings.enableBroadcast).dispose}dispose(){c.requestListeners.delete(this.name),O.delete(this.name)}static getOrCreate(e,t){if(!t){let n=O.get(e);if(!n)throw Error("Can't find channel settings");return n}c.ConfigureChannel(e,t.enableBroadcast||!1,t.enableCaching||!1,t.trace||!1);let s=new M(e,t);return O.set(e,s),s}},G="broadcast-sync",le="browser-message-broker";function he(e){return e.channelName===G}function ue(e){return e.senderId!=null&&e.targetId==null}function be(e){return e.senderId!=null&&e.targetId!=null}var m=Math.random().toString(36).substring(2,9);function ge(e,t=1){let s;return(...n)=>{clearTimeout(s),s=setTimeout(()=>{e(...n)},t)}}var D=new Map,fe=class{constructor(){this.trace=!1,this.senderId=m,this.state=new Map,this.subscribers=new Map,this.braodcasts=new Set,this.__bcChannel=new BroadcastChannel(le),this.__nextMessageAwaters=new Map,this.broadcastedRequests=new Map,this.requestListeners=new Map,this.__bcChannel.onmessage=this.handleBroadcast.bind(this),this.__bcChannel.onmessageerror=this.handleBroadcastError.bind(this),setTimeout(()=>{this.__sendBrokerState(void 0,void 0)},0),this.sendBrokerState=ge(this.__sendBrokerState.bind(this),2)}log(e,t,...s){(this.trace||D.get(t)?.trace)&&console.log(`[${globalThis.constructor.name}(${this.senderId})-${t}] ${e}`,s)}ConfigureChannel(e,t,s,n){D.set(e,{enableBroadcast:t,enableCaching:s,trace:n}),s&&this.state.set(e,void 0),t&&this.braodcasts.add(e)}handleBroadcastError(e){throw Error("BROADCAST FAILED: "+e.data)}__sendBrokerState(e,t){let s=Array.from(this.braodcasts.keys());t&&t.length>0&&(s=s.filter(r=>t.includes(r)));let n={};for(let r of this.state)!r[1]||!s.includes(r[0])||(n[r[0]]=r[1]);let a={id:m,availableState:n,broadcasts:s},o={channelName:G,senderCtx:globalThis.constructor.name,senderId:m,targetId:e,msg:a,channelType:"sync"};this.__bcChannel.postMessage(o),e==null?this.log("Broadcast sync requested","",{brokerState:a}):this.log("Broadcast sync responded","",{targetId:e,brokerState:a})}handleBroadcastSync(e){if(ue(e))return this.sendBrokerState(e.senderId,e.msg.broadcasts);if(be(e))for(let t of Object.entries(e.msg.availableState))this.braodcasts.has(t[0])&&this.state.has(t[0])&&this.state.get(t[0])==null&&this.__notifySubscribers(t[0],t[1],e.senderId),this.log("Broadcast sync responce handled","",e.msg)}handleBroadcast(e){if(this.log("Broadcast received",e.data.channelName,e.data),e.data.targetId!=null&&e.data.targetId!==m){this.log("Broadcast ignored (different targetId)",e.data.channelName);return}if(he(e.data))return this.handleBroadcastSync(e.data);switch(e.data.channelType){case"pubSub":this.__notifySubscribers(e.data.channelName,e.data.msg,e.data.senderId);break;case"req":this.bridgeRequest(e.data.channelName,e.data.msg,e.data.senderId);break;case"rep":let t=this.broadcastedRequests.get(e.data.channelName);if(!t)return;t.resolve(e.data.msg),this.broadcastedRequests.delete(e.data.channelName);break}this.log("Broadcast handled",e.data.channelName,e.data)}__configureBroadcast(e){if(!e.channelName)throw new Error("Invalid subscription");this.braodcasts.add(e.channelName);let t=e.dispose;e.dispose=()=>{t(),this.braodcasts.delete(e.channelName)},e.isBroadcast=!0,this.sendBrokerState()}GetState(e){if(e)return this.state.get(e)}async Broadcast(e,t,s){this._broadcast(e,t,"pubSub",s)}async _broadcast(e,t,s,n){let a=D.get(e);this.log(`Message broadcasted (${s}) to ${n||"all brokers"}`,e,t);let o=await Promise.resolve(t),r={channelName:e,senderCtx:globalThis.constructor.name,senderId:m,targetId:n,msg:o,channelType:s};a?.enableCaching&&this.state.set(e,t),this.__bcChannel.postMessage(r)}async Publish(e,t,s){this.log("Message published",e,t),await this.__notifySubscribers(e,t,m),this.braodcasts.has(e)&&this._broadcast(e,t,"pubSub",s)}async nextMessage(e){let t=this.__nextMessageAwaters.get(e);if(t)return t.promise;let s={promise:void 0,resolve:void 0};return s.promise=new Promise(n=>{s.resolve=n}),this.__nextMessageAwaters.set(e,s),s.promise}Subscribe(e,t,s=!1,n=!0){let a=D.get(e),o=!1;a&&(s=a.enableBroadcast||!1,n=a.enableCaching||!0);let r=this.subscribers.get(e)||[],d=t;r.push(d),this.subscribers.set(e,r);let i={channelName:e,isCached:!1,dispose:()=>{let l=this.subscribers.get(e);if(l==null)return;let T=l.indexOf(d);T!==-1&&l.splice(T,1)},publish:(l,T)=>this.Publish(e,l,T),isDisposed:!1};return s&&this.__configureBroadcast(i),n&&this.state.set(e,void 0),i}bridgeRequest(e,t,s){let n=this.requestListeners.get(e);return n?n.handler(t,s):Promise.resolve(void 0)}Request(e,t,s=!1,n){if(s){this._broadcast(e,t,"req",n);let a=this.broadcastedRequests.get(e);a&&a.resolve(void 0);let o,r={promise:new Promise(d=>o=d),resolve:o};return this.broadcastedRequests.set(e,r),r.promise}else{let a=this.requestListeners.get(e);return a?a.handler(t):Promise.resolve(void 0)}}Reply(e,t,s=!1){if(s){let r=t;t=(d,i)=>this._broadcast(e,r(d),"rep",i)}let n=this.requestListeners,a={channelName:e,get isDisposed(){return n.has(e)},isBroadcast:s,handler:t,dispose:void 0};a.dispose=()=>{a.isDisposed=!0,this.requestListeners.get(e)===a&&this.requestListeners.delete(e)};let o=this.requestListeners.get(e);return o&&(o.isDisposed=!0,console.warn("Request listener has been replaced: "+e)),this.requestListeners.set(e,a),a}async __notifySubscribers(e,t,s){let n=this.subscribers.get(e)||[],a=[];for(let o of n)!o||(a.push(Promise.resolve(o(t,s))),this.log("Handler called",e,o));await Promise.all(a),this.state.has(e)&&this.state.set(e,t),this.__handleAwaiter(e,t),this.log("Message handled",e,t,this)}__handleAwaiter(e,t){let s=this.__nextMessageAwaters.get(e);!s||(s.resolve(t),this.__nextMessageAwaters.delete(e))}};globalThis.BrowserMessageBroker=globalThis.BrowserMessageBroker||new fe;var c=globalThis.BrowserMessageBroker,E=new Map,h=class{constructor(e,t){this.type="pubSub",this.dispose=()=>{c.subscribers.delete(this.name),E.delete(this.name)},this.name="",this.settings={},this.name=e,this.settings=t}static getOrCreate(e,t){if(!t){let n=E.get(e);if(!n)throw Error("Can't find channel settings");return n}c.ConfigureChannel(e,t.enableBroadcast||!1,t.enableCaching||!1,t.trace||!1);let s=new h(e,t);return E.set(e,s),s}async send(e,t){c.Publish(this.name,e,t)}static async publish(e,t,s){c.Publish(e,t,s)}static async broadcast(e,t,s){c.Broadcast(e,t,s)}subscribe(e){return c.Subscribe(this.name,e,this.settings.enableBroadcast,this.settings.enableCaching).dispose}getState(){return c.GetState(this.name)}static GetState(e){return c.GetState(e)}nextMessage(){return c.nextMessage(this.name)}static nextMessage(e){return c.nextMessage(e)}};var u={ADD_TODO:"addTodo",TODO_ADDED:"todoAdded",TODO_ERR:"todoErr",MODIFY_TODO:"modifyTodo",COMPLETE_TODO:"completeTodo",TODO_MODIFIED:"todoModified",DEL_TODO:"delTodo",TODO_DELETED:"todoDeleted",GET_ALL_TODOS:"getAllTodos",TODO_SELECTED:"todoSelected",CHECK_DATA_SOURCE:"checkDataSource",DATA_SOURCE_READY:"dataSourceReady"},$=h.getOrCreate(u.TODO_ADDED,{enableBroadcast:!0,enableCaching:!1}),g=h.getOrCreate(u.TODO_ERR,{enableBroadcast:!0,enableCaching:!1}),W=h.getOrCreate(u.TODO_DELETED,{enableBroadcast:!0,enableCaching:!1}),x=h.getOrCreate(u.TODO_MODIFIED,{enableBroadcast:!0,enableCaching:!1}),K=h.getOrCreate(u.DATA_SOURCE_READY,{enableBroadcast:!0,enableCaching:!0}),V=h.getOrCreate(u.ADD_TODO,{enableBroadcast:!0,enableCaching:!1}),Y=h.getOrCreate(u.COMPLETE_TODO,{enableBroadcast:!0,enableCaching:!1}),U=h.getOrCreate(u.DEL_TODO,{enableBroadcast:!0,enableCaching:!1}),H=h.getOrCreate(u.MODIFY_TODO,{enableBroadcast:!0,enableCaching:!1}),z=M.getOrCreate(u.GET_ALL_TODOS,{enableBroadcast:!0}),Ae=h.getOrCreate(u.TODO_SELECTED,{enableBroadcast:!0,enableCaching:!0});var p=F("Todos",1,{upgrade(e){e.createObjectStore("todo",{keyPath:"id",autoIncrement:!0}).createIndex("isDone","isDone")}});V.subscribe(De);Y.subscribe(Ce);U.subscribe(Te);H.subscribe(pe);z.reply(me);function me(e){return f(this,null,function*(){try{return yield(yield p).getAll("todo")}catch(t){console.log(t),g.send({message:"Can't get all todos",context:{}})}return Promise.resolve([])})}function pe(e){return f(this,null,function*(){try{let t=yield p,s=yield t.get("todo",e.id);s.text=e.newText,yield t.put("todo",s),x.send(s)}catch(t){g.send({message:`Can't modify todo. Change: text = '${e.newText}'`,context:{id:e.id}})}})}function Te(e){return f(this,null,function*(){try{yield(yield p).delete("todo",e.id),W.send(e)}catch(t){g.send({message:"Can't delete todo",context:e})}})}function Ce(e){return f(this,null,function*(){try{yield(yield p).put("todo",L(v({},e),{isDone:!0})),e.isDone=!0,x.send(e)}catch(t){g.send({message:"Can't complete todo",context:e})}})}function De(e){return f(this,null,function*(){if(!e.text||e.text===""){g.send({context:e,message:"Can't add todo without text"});return}let t={text:e.text,isDone:!1};try{let n=yield(yield p).add("todo",t);t.id=n,$.send(t)}catch(s){g.send({message:"Can't add todo. ",context:e})}})}K.send(!0);})();
//# sourceMappingURL=sharedWorker.js.map
