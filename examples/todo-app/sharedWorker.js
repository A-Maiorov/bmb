(()=>{var R=Object.defineProperty,j=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var E=Object.getOwnPropertySymbols;var K=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var O=(e,t,o)=>t in e?R(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o,B=(e,t)=>{for(var o in t||(t={}))K.call(t,o)&&O(e,o,t[o]);if(E)for(var o of E(t))W.call(t,o)&&O(e,o,t[o]);return e},w=(e,t)=>j(e,F(t));var b=(e,t,o)=>new Promise((s,r)=>{var a=i=>{try{l(o.next(i))}catch(h){r(h)}},n=i=>{try{l(o.throw(i))}catch(h){r(h)}},l=i=>i.done?s(i.value):Promise.resolve(i.value).then(a,n);l((o=o.apply(e,t)).next())});var G=(e,t)=>t.some(o=>e instanceof o),_,M;function N(){return _||(_=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function V(){return M||(M=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var C=new WeakMap,m=new WeakMap,x=new WeakMap,g=new WeakMap,y=new WeakMap;function Y(e){let t=new Promise((o,s)=>{let r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",n)},a=()=>{o(u(e.result)),r()},n=()=>{s(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",n)});return t.then(o=>{o instanceof IDBCursor&&C.set(o,e)}).catch(()=>{}),y.set(t,e),t}function U(e){if(m.has(e))return;let t=new Promise((o,s)=>{let r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",n),e.removeEventListener("abort",n)},a=()=>{o(),r()},n=()=>{s(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",n),e.addEventListener("abort",n)});m.set(e,t)}var I={get(e,t,o){if(e instanceof IDBTransaction){if(t==="done")return m.get(e);if(t==="objectStoreNames")return e.objectStoreNames||x.get(e);if(t==="store")return o.objectStoreNames[1]?void 0:o.objectStore(o.objectStoreNames[0])}return u(e[t])},set(e,t,o){return e[t]=o,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function A(e){I=e(I)}function H(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...o){let s=e.call(p(this),t,...o);return x.set(s,t.sort?t.sort():[t]),u(s)}:V().includes(e)?function(...t){return e.apply(p(this),t),u(C.get(this))}:function(...t){return u(e.apply(p(this),t))}}function $(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&U(e),G(e,N())?new Proxy(e,I):e)}function u(e){if(e instanceof IDBRequest)return Y(e);if(g.has(e))return g.get(e);let t=$(e);return t!==e&&(g.set(e,t),y.set(t,e)),t}var p=e=>y.get(e);function k(e,t,{blocked:o,upgrade:s,blocking:r,terminated:a}={}){let n=indexedDB.open(e,t),l=u(n);return s&&n.addEventListener("upgradeneeded",i=>{s(u(n.result),i.oldVersion,i.newVersion,u(n.transaction))}),o&&n.addEventListener("blocked",()=>o()),l.then(i=>{a&&i.addEventListener("close",()=>a()),r&&i.addEventListener("versionchange",()=>r())}).catch(()=>{}),l}var z=["get","getKey","getAll","getAllKeys","count"],J=["put","add","delete","clear"],S=new Map;function L(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(S.get(t))return S.get(t);let o=t.replace(/FromIndex$/,""),s=t!==o,r=J.includes(o);if(!(o in(s?IDBIndex:IDBObjectStore).prototype)||!(r||z.includes(o)))return;let a=async function(n,...l){let i=this.transaction(n,r?"readwrite":"readonly"),h=i.store;return s&&(h=h.index(l.shift())),(await Promise.all([h[o](...l),r&&i.done]))[0]};return S.set(t,a),a}A(e=>({...e,get:(t,o,s)=>L(t,o)||e.get(t,o,s),has:(t,o)=>!!L(t,o)||e.has(t,o)}));var P="broadcast-sync",Q="browser-message-broker";function X(e){return e.subsKey===P}function Z(e){return e.senderId!=null&&e.targetId==null}function q(e){return e.senderId!=null&&e.targetId!=null}var f=Math.random().toString(36).substring(2,9);function ee(e,t=1){let o;return(...s)=>{clearTimeout(o),o=setTimeout(()=>{e(...s)},t)}}var te=class{constructor(){if(this.trace=!1,this.senderId=f,this.state=new Map,this.subscribers=new Map,this.braodcasts=new Set,this.__bcChannel=new BroadcastChannel(Q),globalThis.constructor.name==="Window"){let e=new CustomEvent("bmb-ready",{detail:this});globalThis.document.dispatchEvent(e)}this.__bcChannel.onmessage=this.handleBroadcast.bind(this),this.__bcChannel.onmessageerror=this.handleBroadcastError.bind(this),this.sendBrokerState=ee(this.__sendBrokerState.bind(this),2),this.sendBrokerState()}handleBroadcastError(e){throw Error("BROADCAST FAILED: "+e.data)}__sendBrokerState(e,t){let o=Array.from(this.braodcasts.keys());t&&t.length>0&&(o=o.filter(n=>t.includes(n)));let s={};for(let n of this.state)!n[1]||!o.includes(n[0])||(s[n[0]]=n[1]);let r={id:f,availableState:s,broadcasts:o},a={subsKey:P,senderCtx:globalThis.constructor.name,senderId:f,targetId:e,msg:r};this.__bcChannel.postMessage(a),this.trace&&(e==null?console.log("[Broadcast sync requested]",a,this):console.log("[Broadcast sync responded]",e,a,this))}handleBroadcastSync(e){if(Z(e))return this.sendBrokerState(e.senderId,e.msg.broadcasts);if(q(e))for(let t of Object.entries(e.msg.availableState))this.braodcasts.has(t[0])&&this.state.has(t[0])&&this.state.get(t[0])==null&&this.__notifySubscribers(t[0],t[1],e.senderId),this.trace&&console.log("[Broadcast sync responce handled]",e,this)}handleBroadcast(e){if(this.trace&&console.log("[Broadcast received]",e.data,this),e.data.targetId!=null&&e.data.targetId!==f){this.trace&&console.log("[Broadcast ignored]",e.data,this);return}if(X(e.data))return this.handleBroadcastSync(e.data);this.__notifySubscribers(e.data.subsKey,e.data.msg,e.data.senderId),this.trace&&console.log("[Broadcast handled]",e.data,this)}__configureBroadcast(e){if(!e.key)throw new Error("Invalid subscription");this.braodcasts.add(e.key);let t=e.dispose;e.dispose=()=>{t(),this.braodcasts.delete(e.key)},e.isBroadcast=!0,this.sendBrokerState()}GetState(e){if(e)return this.state.get(e)}async Publish(e,t,o){if(this.trace&&console.log("[Message published]",e,t,this),await this.__notifySubscribers(e,t,f),!this.braodcasts.has(e))return;let s={subsKey:e,senderCtx:globalThis.constructor.name,senderId:f,targetId:o,msg:t};this.__bcChannel.postMessage(s)}Subscribe(e,t,o=!1,s=!0){let r=this.subscribers.get(e)||[],a=t;r.push(a),this.subscribers.set(e,r);let n={key:e,isCached:!1,dispose:()=>{r.splice(r.indexOf(a),1),n.isDisposed=!0},publish:(l,i)=>this.Publish(e,l,i),isDisposed:!1};return o&&this.__configureBroadcast(n),s&&this.state.set(e,void 0),this.trace&&console.log("[Subscribe]",n,this),n}async __notifySubscribers(e,t,o){let s=this.subscribers.get(e)||[],r=[];for(let a of s)!a||(r.push(Promise.resolve(a(t,o))),this.trace&&console.log("[Handler called]",a,this));await Promise.all(r),this.state.has(e)&&this.state.set(e,t),this.trace&&console.log("[Message handled]",e,t,this)}};globalThis.BrowserMessageBroker=globalThis.BrowserMessageBroker||new te;var d=globalThis.BrowserMessageBroker;var c={ADD_TODO:"addTodo",TODO_ADDED:"todoAdded",TODO_ERR:"todoErr",MODIFY_TODO:"modifyTodo",COMPLETE_TODO:"completeTodo",TODO_MODIFIED:"todoModified",DEL_TODO:"delTodo",TODO_DELETED:"todoDeleted",GET_ALL_TODOS:"getAllTodos",ALL_TODOS:"allTodos",TODO_SELECTED:"todoSelected",CHECK_DATA_SOURCE:"checkDataSource",DATA_SOURCE_READY:"dataSourceReady"};d.trace=!0;var D=d.Subscribe(c.TODO_ERR,void 0,!0),oe=d.Subscribe(c.TODO_ADDED,void 0,!0,!1),se=d.Subscribe(c.TODO_DELETED,void 0,!0,!1),v=d.Subscribe(c.TODO_MODIFIED,void 0,!0,!1),ne=d.Subscribe(c.ALL_TODOS,void 0,!0,!1),T=k("Todos",1,{upgrade(e){e.createObjectStore("todo",{keyPath:"id",autoIncrement:!0}).createIndex("isDone","isDone")}});d.Subscribe(c.ADD_TODO,ce,!0,!1);d.Subscribe(c.COMPLETE_TODO,de,!0,!1);d.Subscribe(c.DEL_TODO,ie,!0,!1);d.Subscribe(c.MODIFY_TODO,ae,!0,!1);d.Subscribe(c.GET_ALL_TODOS,re,!0,!1);function re(e,t){return b(this,null,function*(){try{let s=yield(yield T).getAll("todo");ne.publish(s,t)}catch(o){console.log(o),D.publish({message:"Can't get all todos",context:{}})}})}function ae(e){return b(this,null,function*(){try{let t=yield T,o=yield t.get("todo",e.id);o.text=e.newText,yield t.put("todo",o),v.publish(o)}catch(t){D.publish({message:`Can't modify todo. Change: text = '${e.newText}'`,context:{id:e.id}})}})}function ie(e){return b(this,null,function*(){console.log("handleDeleteTodo");try{yield(yield T).delete("todo",e.id),se.publish(e)}catch(t){D.publish({message:"Can't delete todo",context:e})}})}function de(e){return b(this,null,function*(){console.log("handleCompleteTodo");try{yield(yield T).put("todo",w(B({},e),{isDone:!0})),e.isDone=!0,v.publish(e)}catch(t){D.publish({message:"Can't complete todo",context:e})}})}function ce(e){return b(this,null,function*(){if(console.log("handleAddTodo"),!e.text||e.text===""){D.publish({context:e,message:"Can't add todo without text"});return}let t={text:e.text,isDone:!1};try{let s=yield(yield T).add("todo",t);t.id=s,oe.publish(t)}catch(o){D.publish({message:"Can't add todo. ",context:e})}})}d.Subscribe(c.DATA_SOURCE_READY,void 0,!0,!1).publish(void 0);})();
//# sourceMappingURL=sharedWorker.js.map
