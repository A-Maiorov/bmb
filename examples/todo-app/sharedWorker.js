(()=>{var N=Object.defineProperty,j=Object.defineProperties;var F=Object.getOwnPropertyDescriptors;var B=Object.getOwnPropertySymbols;var G=Object.prototype.hasOwnProperty,W=Object.prototype.propertyIsEnumerable;var E=(e,t,s)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:s}):e[t]=s,S=(e,t)=>{for(var s in t||(t={}))G.call(t,s)&&E(e,s,t[s]);if(B)for(var s of B(t))W.call(t,s)&&E(e,s,t[s]);return e},O=(e,t)=>j(e,F(t));var f=(e,t,s)=>new Promise((r,o)=>{var a=i=>{try{d(s.next(i))}catch(h){o(h)}},n=i=>{try{d(s.throw(i))}catch(h){o(h)}},d=i=>i.done?r(i.value):Promise.resolve(i.value).then(a,n);d((s=s.apply(e,t)).next())});var Y=(e,t)=>t.some(s=>e instanceof s),M,C;function K(){return M||(M=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])}function U(){return C||(C=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])}var x=new WeakMap,_=new WeakMap,A=new WeakMap,T=new WeakMap,I=new WeakMap;function V(e){let t=new Promise((s,r)=>{let o=()=>{e.removeEventListener("success",a),e.removeEventListener("error",n)},a=()=>{s(u(e.result)),o()},n=()=>{r(e.error),o()};e.addEventListener("success",a),e.addEventListener("error",n)});return t.then(s=>{s instanceof IDBCursor&&x.set(s,e)}).catch(()=>{}),I.set(t,e),t}function $(e){if(_.has(e))return;let t=new Promise((s,r)=>{let o=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",n),e.removeEventListener("abort",n)},a=()=>{s(),o()},n=()=>{r(e.error||new DOMException("AbortError","AbortError")),o()};e.addEventListener("complete",a),e.addEventListener("error",n),e.addEventListener("abort",n)});_.set(e,t)}var w={get(e,t,s){if(e instanceof IDBTransaction){if(t==="done")return _.get(e);if(t==="objectStoreNames")return e.objectStoreNames||A.get(e);if(t==="store")return s.objectStoreNames[1]?void 0:s.objectStore(s.objectStoreNames[0])}return u(e[t])},set(e,t,s){return e[t]=s,!0},has(e,t){return e instanceof IDBTransaction&&(t==="done"||t==="store")?!0:t in e}};function v(e){w=e(w)}function H(e){return e===IDBDatabase.prototype.transaction&&!("objectStoreNames"in IDBTransaction.prototype)?function(t,...s){let r=e.call(m(this),t,...s);return A.set(r,t.sort?t.sort():[t]),u(r)}:U().includes(e)?function(...t){return e.apply(m(this),t),u(x.get(this))}:function(...t){return u(e.apply(m(this),t))}}function z(e){return typeof e=="function"?H(e):(e instanceof IDBTransaction&&$(e),Y(e,K())?new Proxy(e,w):e)}function u(e){if(e instanceof IDBRequest)return V(e);if(T.has(e))return T.get(e);let t=z(e);return t!==e&&(T.set(e,t),I.set(t,e)),t}var m=e=>I.get(e);function R(e,t,{blocked:s,upgrade:r,blocking:o,terminated:a}={}){let n=indexedDB.open(e,t),d=u(n);return r&&n.addEventListener("upgradeneeded",i=>{r(u(n.result),i.oldVersion,i.newVersion,u(n.transaction))}),s&&n.addEventListener("blocked",()=>s()),d.then(i=>{a&&i.addEventListener("close",()=>a()),o&&i.addEventListener("versionchange",()=>o())}).catch(()=>{}),d}var J=["get","getKey","getAll","getAllKeys","count"],Q=["put","add","delete","clear"],y=new Map;function L(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&typeof t=="string"))return;if(y.get(t))return y.get(t);let s=t.replace(/FromIndex$/,""),r=t!==s,o=Q.includes(s);if(!(s in(r?IDBIndex:IDBObjectStore).prototype)||!(o||J.includes(s)))return;let a=async function(n,...d){let i=this.transaction(n,o?"readwrite":"readonly"),h=i.store;return r&&(h=h.index(d.shift())),(await Promise.all([h[s](...d),o&&i.done]))[0]};return y.set(t,a),a}v(e=>({...e,get:(t,s,r)=>L(t,s)||e.get(t,s,r),has:(t,s)=>!!L(t,s)||e.has(t,s)}));var P="broadcast-sync",X="browser-message-broker";function Z(e){return e.channelName===P}function ee(e){return e.senderId!=null&&e.targetId==null}function te(e){return e.senderId!=null&&e.targetId!=null}var g=Math.random().toString(36).substring(2,9);function se(e,t=1){let s;return(...r)=>{clearTimeout(s),s=setTimeout(()=>{e(...r)},t)}}var b=new Map,re=class{constructor(){this.trace=!1,this.senderId=g,this.state=new Map,this.subscribers=new Map,this.braodcasts=new Set,this.__bcChannel=new BroadcastChannel(X),this.__nextMessageAwaters=new Map,this.broadcastedRequests=new Map,this.requestListeners=new Map,this.__bcChannel.onmessage=this.handleBroadcast.bind(this),this.__bcChannel.onmessageerror=this.handleBroadcastError.bind(this),setTimeout(()=>{this.__sendBrokerState(void 0,void 0)},0),this.sendBrokerState=se(this.__sendBrokerState.bind(this),2)}ConfigureChannel(e,t,s,r){b.set(e,{enableBroadcast:t,enableCaching:s,trace:r}),s&&this.state.set(e,void 0),t&&this.braodcasts.add(e)}handleBroadcastError(e){throw Error("BROADCAST FAILED: "+e.data)}__sendBrokerState(e,t){let s=Array.from(this.braodcasts.keys());t&&t.length>0&&(s=s.filter(n=>t.includes(n)));let r={};for(let n of this.state)!n[1]||!s.includes(n[0])||(r[n[0]]=n[1]);let o={id:g,availableState:r,broadcasts:s},a={channelName:P,senderCtx:globalThis.constructor.name,senderId:g,targetId:e,msg:o,channelType:"sync"};this.__bcChannel.postMessage(a),this.trace&&(e==null?console.log("[Broadcast sync requested]",a,this):console.log("[Broadcast sync responded]",e,a,this))}handleBroadcastSync(e){if(ee(e))return this.sendBrokerState(e.senderId,e.msg.broadcasts);if(te(e))for(let t of Object.entries(e.msg.availableState))this.braodcasts.has(t[0])&&this.state.has(t[0])&&this.state.get(t[0])==null&&this.__notifySubscribers(t[0],t[1],e.senderId),this.trace&&console.log("[Broadcast sync responce handled]",e,this)}handleBroadcast(e){let t=this.trace||b.get(e.data.channelName)?.trace;if(t&&console.log("[Broadcast received]",e.data,this),e.data.targetId!=null&&e.data.targetId!==g){t&&console.log("[Broadcast ignored]",e.data,this);return}if(Z(e.data))return this.handleBroadcastSync(e.data);switch(e.data.channelType){case"pubSub":this.__notifySubscribers(e.data.channelName,e.data.msg,e.data.senderId);break;case"req":this.bridgeRequest(e.data.channelName,e.data.msg,e.data.senderId);break;case"rep":let s=this.broadcastedRequests.get(e.data.channelName);if(!s)return;s.resolve(e.data.msg),this.broadcastedRequests.delete(e.data.channelName);break}t&&console.log("[Broadcast handled]",e.data,this)}__configureBroadcast(e){if(!e.channelName)throw new Error("Invalid subscription");this.braodcasts.add(e.channelName);let t=e.dispose;e.dispose=()=>{t(),this.braodcasts.delete(e.channelName)},e.isBroadcast=!0,this.sendBrokerState()}GetState(e){if(e)return this.state.get(e)}async Broadcast(e,t,s){this._broadcast(e,t,"pubSub",s)}async _broadcast(e,t,s,r){let o=b.get(e);(this.trace||o?.trace)&&console.log("[Message broadcasted]",e,t,this);let a=await Promise.resolve(t),n={channelName:e,senderCtx:globalThis.constructor.name,senderId:g,targetId:r,msg:a,channelType:s};o?.enableCaching&&this.state.set(e,t),this.__bcChannel.postMessage(n)}async Publish(e,t,s){(this.trace||b.get(e)?.trace)&&console.log("[Message published]",e,t,this),await this.__notifySubscribers(e,t,g),this.braodcasts.has(e)&&this._broadcast(e,t,"pubSub",s)}async nextMessage(e){let t=this.__nextMessageAwaters.get(e);if(t)return t.promise;let s={promise:void 0,resolve:void 0};return s.promise=new Promise(r=>{s.resolve=r}),this.__nextMessageAwaters.set(e,s),s.promise}Subscribe(e,t,s=!1,r=!0){let o=b.get(e),a=!1;o&&(s=o.enableBroadcast,r=o.enableCaching);let n=this.subscribers.get(e)||[],d=t;n.push(d),this.subscribers.set(e,n);let i={channelName:e,isCached:!1,dispose:()=>{n.splice(n.indexOf(d),1),i.isDisposed=!0},publish:(h,q)=>this.Publish(e,h,q),isDisposed:!1};return s&&this.__configureBroadcast(i),r&&this.state.set(e,void 0),(this.trace||b.get(e)?.trace)&&console.log(`[Subscribe${a?", preconfigured settings":""}]`,i,this),i}bridgeRequest(e,t,s){let r=this.requestListeners.get(e);return r?r.handler(t,s):Promise.resolve(void 0)}Request(e,t,s=!1,r){if(s){this._broadcast(e,t,"req",r);let o=this.broadcastedRequests.get(e);o&&o.resolve(void 0);let a,n={promise:new Promise(d=>a=d),resolve:a};return this.broadcastedRequests.set(e,n),n.promise}else{let o=this.requestListeners.get(e);return o?o.handler(t):Promise.resolve(void 0)}}Reply(e,t,s=!1){if(s){let a=t;t=(n,d)=>this._broadcast(e,a(n),"rep",d)}let r={channelName:e,isDisposed:!0,isBroadcast:s,handler:t,dispose:void 0};r.dispose=()=>{r.isDisposed=!0,this.requestListeners.get(e)===r&&this.requestListeners.delete(e)};let o=this.requestListeners.get(e);return o&&(o.isDisposed=!0,console.warn("Request listener replaced: "+e)),this.requestListeners.set(e,r),r}async __notifySubscribers(e,t,s){let r=this.subscribers.get(e)||[],o=this.trace||b.get(e)?.trace,a=[];for(let n of r)!n||(a.push(Promise.resolve(n(t,s))),o&&console.log("[Handler called]",n,this));await Promise.all(a),this.state.has(e)&&this.state.set(e,t),this.__handleAwaiter(e,t),o&&console.log("[Message handled]",e,t,this)}__handleAwaiter(e,t){let s=this.__nextMessageAwaters.get(e);!s||(s.resolve(t),this.__nextMessageAwaters.delete(e))}};globalThis.BrowserMessageBroker=globalThis.BrowserMessageBroker||new re;var c=globalThis.BrowserMessageBroker;var l={ADD_TODO:"addTodo",TODO_ADDED:"todoAdded",TODO_ERR:"todoErr",MODIFY_TODO:"modifyTodo",COMPLETE_TODO:"completeTodo",TODO_MODIFIED:"todoModified",DEL_TODO:"delTodo",TODO_DELETED:"todoDeleted",GET_ALL_TODOS:"getAllTodos",TODO_SELECTED:"todoSelected",CHECK_DATA_SOURCE:"checkDataSource",DATA_SOURCE_READY:"dataSourceReady"};var p=c.Subscribe(l.TODO_ERR,void 0,!0),ne=c.Subscribe(l.TODO_ADDED,void 0,!0,!1),oe=c.Subscribe(l.TODO_DELETED,void 0,!0,!1),k=c.Subscribe(l.TODO_MODIFIED,void 0,!0,!1),D=R("Todos",1,{upgrade(e){e.createObjectStore("todo",{keyPath:"id",autoIncrement:!0}).createIndex("isDone","isDone")}});c.Subscribe(l.ADD_TODO,le,!0,!1);c.Subscribe(l.COMPLETE_TODO,ce,!0,!1);c.Subscribe(l.DEL_TODO,de,!0,!1);c.Subscribe(l.MODIFY_TODO,ie,!0,!1);c.Reply(l.GET_ALL_TODOS,ae,!0);function ae(e){return f(this,null,function*(){try{return yield(yield D).getAll("todo")}catch(t){console.log(t),p.publish({message:"Can't get all todos",context:{}})}})}function ie(e){return f(this,null,function*(){try{let t=yield D,s=yield t.get("todo",e.id);s.text=e.newText,yield t.put("todo",s),k.publish(s)}catch(t){p.publish({message:`Can't modify todo. Change: text = '${e.newText}'`,context:{id:e.id}})}})}function de(e){return f(this,null,function*(){try{yield(yield D).delete("todo",e.id),oe.publish(e)}catch(t){p.publish({message:"Can't delete todo",context:e})}})}function ce(e){return f(this,null,function*(){try{yield(yield D).put("todo",O(S({},e),{isDone:!0})),e.isDone=!0,k.publish(e)}catch(t){p.publish({message:"Can't complete todo",context:e})}})}function le(e){return f(this,null,function*(){if(!e.text||e.text===""){p.publish({context:e,message:"Can't add todo without text"});return}let t={text:e.text,isDone:!1};try{let r=yield(yield D).add("todo",t);t.id=r,ne.publish(t)}catch(s){p.publish({message:"Can't add todo. ",context:e})}})}c.ConfigureChannel(l.DATA_SOURCE_READY,!0,!0,!1);c.Broadcast(l.DATA_SOURCE_READY,!0);})();
//# sourceMappingURL=sharedWorker.js.map
