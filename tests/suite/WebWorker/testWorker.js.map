{
  "version": 3,
  "sources": ["../../../browser-message-broker/src/Broker.ts", "testWorker.ts"],
  "sourcesContent": ["export interface Subscription<T> {\r\n  dispose: () => void;\r\n  enableBroadcast: () => Subscription<T>;\r\n  publish: (msg: any, targetId?: string) => Promise<void>;\r\n  key: string;\r\n  isDisposed?: boolean;\r\n  isBroadcast?: boolean;\r\n}\r\nexport type THandler<T = unknown> = (\r\n  msg: T,\r\n  senderId: string\r\n) => void | Promise<void>;\r\n\r\nexport interface IBroker {\r\n  state: Map<string, any>;\r\n  subscribers: Map<string, THandler[]>;\r\n\r\n  braodcasts: Set<string>;\r\n  GetState<IStateItem>(subsKey: string): IStateItem | undefined;\r\n  Subscribe<T>(\r\n    subsKey: string,\r\n    handler?: THandler<T>,\r\n    enableBroadcast?: boolean\r\n  ): Subscription<T>;\r\n  Publish: (subsKey: string, msg: Object, targetId?: string) => Promise<void>;\r\n}\r\ndeclare global {\r\n  var BrowserMessageBroker: IBroker;\r\n}\r\n\r\nexport interface IBroadcastEnvelope<T = unknown> {\r\n  senderId: string;\r\n  targetId?: string;\r\n  subsKey: string;\r\n  msg: T;\r\n}\r\n\r\nexport interface IBrokerState {\r\n  id: string;\r\n  broadcasts: string[];\r\n  //context: TBrokerContext;\r\n  availableState: { [x: string]: any };\r\n}\r\n\r\nexport interface IBroadcastSyncEnvelope\r\n  extends IBroadcastEnvelope<IBrokerState> {\r\n  subsKey: typeof BROADCAST_SYNC;\r\n  msg: IBrokerState;\r\n}\r\n\r\nfunction isBroadcastSync(e: IBroadcastEnvelope): e is IBroadcastSyncEnvelope {\r\n  return e.subsKey === BROADCAST_SYNC;\r\n}\r\n\r\nfunction isSyncReq(e: IBroadcastEnvelope) {\r\n  return e.senderId != undefined && e.targetId == undefined;\r\n}\r\nfunction isSyncResp(e: IBroadcastEnvelope) {\r\n  return e.senderId != undefined && e.targetId != undefined;\r\n}\r\n\r\nexport const senderId = Math.random().toString(36).substring(2, 9);\r\nconst BROADCAST_SYNC = \"broadcast-sync\";\r\nconst BROWSER_MESSAGE_BROKER = \"browser-message-broker\";\r\n\r\nfunction debounce<T extends Function>(func: T, timeout = 1) {\r\n  let timer: number;\r\n  return (...args: unknown[]) => {\r\n    clearTimeout(timer);\r\n    timer = setTimeout(() => {\r\n      func(...args);\r\n    }, timeout);\r\n  };\r\n}\r\n\r\nclass Broker implements IBroker {\r\n  senderId = senderId;\r\n  state = new Map<string, any>();\r\n  subscribers = new Map<string, THandler[]>();\r\n  braodcasts = new Set<string>(); //new Map<string, BroadcastChannel>();\r\n  private __bcChannel = new BroadcastChannel(BROWSER_MESSAGE_BROKER);\r\n\r\n  constructor() {\r\n    if (globalThis.constructor.name === \"Window\") {\r\n      const ev = new CustomEvent(\"bmb-ready\", { detail: this });\r\n      globalThis.document.dispatchEvent(ev);\r\n    }\r\n    this.__bcChannel.onmessage = this.handleBroadcast.bind(this);\r\n    this.__bcChannel.onmessageerror = this.handleBroadcastError.bind(this);\r\n\r\n    this.sendBrokerState = debounce(this.__sendBrokerState.bind(this), 1);\r\n\r\n    this.sendBrokerState();\r\n  }\r\n\r\n  private handleBroadcastError(ev: MessageEvent<IBroadcastEnvelope>) {\r\n    throw Error(\"BROADCAST FAILED: \" + ev.data);\r\n  }\r\n\r\n  //private knownBrokers = new Map<string, IBrokerState>();\r\n  private sendBrokerState: (\r\n    targetId?: string,\r\n    filterBroadcasts?: string[]\r\n  ) => void;\r\n  private __sendBrokerState(targetId?: string, filterBroadcasts?: string[]) {\r\n    let currentBroadcasts = Array.from(this.braodcasts.keys());\r\n\r\n    if (filterBroadcasts && filterBroadcasts.length > 0) {\r\n      currentBroadcasts = currentBroadcasts.filter((k) =>\r\n        filterBroadcasts.includes(k)\r\n      );\r\n    }\r\n\r\n    const availableState: { [x: string]: any } = {};\r\n    for (const x of this.state) {\r\n      if (!x[1]) continue;\r\n      if (!currentBroadcasts.includes(x[0])) continue;\r\n      availableState[x[0]] = x[1];\r\n    }\r\n\r\n    const state: IBrokerState = {\r\n      id: senderId,\r\n      availableState,\r\n      broadcasts: currentBroadcasts,\r\n    };\r\n\r\n    const ev: IBroadcastSyncEnvelope = {\r\n      msg: state,\r\n      subsKey: BROADCAST_SYNC,\r\n      senderId,\r\n      targetId,\r\n    };\r\n\r\n    this.__bcChannel.postMessage(ev);\r\n  }\r\n\r\n  private handleBroadcastSync(ev: IBroadcastSyncEnvelope) {\r\n    if (isSyncReq(ev))\r\n      return this.sendBrokerState(ev.senderId, ev.msg.broadcasts);\r\n    if (isSyncResp(ev)) {\r\n      for (const s of Object.entries(ev.msg.availableState)) {\r\n        if (this.braodcasts.has(s[0]) && this.state.get(s[0]) == undefined) {\r\n          this.__notifySubscribers(s[0], s[1], ev.senderId);\r\n        }\r\n      }\r\n    }\r\n  }\r\n\r\n  private handleBroadcast(ev: MessageEvent<IBroadcastEnvelope>) {\r\n    console.log(\"BROADCAST RECEIVED: \", ev.data);\r\n\r\n    if (ev.data.targetId != undefined && ev.data.targetId !== senderId) return;\r\n\r\n    if (isBroadcastSync(ev.data)) return this.handleBroadcastSync(ev.data);\r\n\r\n    return this.__notifySubscribers(\r\n      ev.data.subsKey,\r\n      ev.data.msg,\r\n      ev.data.senderId\r\n    );\r\n  }\r\n\r\n  /**\r\n   * Bridge pub/sub messages to broadcast channel\r\n   * @param subsKey\r\n   * @returns {Subscription}\r\n   */\r\n  private __configureBroadcast(subscription: Subscription<any>): void {\r\n    if (!subscription.key) {\r\n      throw new Error(`Invalid subscription`);\r\n    }\r\n    this.braodcasts.add(subscription.key);\r\n    const originalDispose = subscription.dispose;\r\n    subscription.dispose = () => {\r\n      originalDispose();\r\n      this.braodcasts.delete(subscription.key);\r\n    };\r\n    subscription.isBroadcast = true;\r\n    this.sendBrokerState();\r\n  }\r\n\r\n  GetState<T>(subsKey: string): T | undefined {\r\n    if (subsKey) {\r\n      return this.state.get(subsKey) as T;\r\n    } else {\r\n      return undefined;\r\n    }\r\n  }\r\n  async Publish(subsKey: string, msg: Object, targetId?: string) {\r\n    await this.__notifySubscribers(subsKey, msg, senderId);\r\n    const bc = this.braodcasts.has(subsKey);\r\n    if (!bc) return;\r\n\r\n    const envelope: IBroadcastEnvelope = {\r\n      msg,\r\n      senderId: senderId,\r\n      targetId: targetId,\r\n      subsKey,\r\n    };\r\n    this.__bcChannel.postMessage(envelope);\r\n  }\r\n\r\n  Subscribe<T>(\r\n    key: string,\r\n    handler?: THandler<T>,\r\n    enableBroadcast = false\r\n  ): Subscription<T> {\r\n    const subs = this.subscribers.get(key) || [];\r\n    const hdl = handler as (msg: unknown) => void;\r\n    subs.push(hdl);\r\n    this.subscribers.set(key, subs);\r\n    const subscription: Subscription<T> = {\r\n      key: key,\r\n      dispose: () => {\r\n        subs.splice(subs.indexOf(hdl), 1);\r\n        subscription.isDisposed = true;\r\n      },\r\n      enableBroadcast: () => {\r\n        return {} as Subscription<T>;\r\n      },\r\n      publish: (msg, targetId?: string) => this.Publish(key, msg, targetId),\r\n      isDisposed: false,\r\n    };\r\n    subscription.enableBroadcast = () => {\r\n      this.__configureBroadcast(subscription);\r\n      return subscription;\r\n    };\r\n\r\n    if (enableBroadcast) this.__configureBroadcast(subscription);\r\n\r\n    return subscription;\r\n  }\r\n\r\n  async __notifySubscribers(subsKey: string, msg: unknown, sId: string) {\r\n    const handlers = this.subscribers.get(subsKey) || [];\r\n\r\n    const allSubscribersPromises: Promise<void>[] = [];\r\n    for (const h of handlers) {\r\n      if (!h) continue;\r\n      allSubscribersPromises.push(Promise.resolve(h(msg, sId)));\r\n    }\r\n\r\n    await Promise.all(allSubscribersPromises);\r\n    BMB.state.set(subsKey, msg);\r\n  }\r\n}\r\n\r\nglobalThis.BrowserMessageBroker =\r\n  globalThis.BrowserMessageBroker || new Broker();\r\n\r\nexport const BMB = globalThis.BrowserMessageBroker;\r\n", "import { BMB } from \"browser-message-broker\";\r\n\r\nconst responseToWindow = BMB.Subscribe(\"testResp\").enableBroadcast();\r\n\r\nconst requestFromWindow = BMB.Subscribe(\"testReq\", (_) => {\r\n  BMB.Publish(\"testResp\", { payload: \"response\" });\r\n}).enableBroadcast();\r\n\r\n//let window know that worker is ready and execute test\r\npostMessage(\"ready\");\r\n"],
  "mappings": "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",
  "names": []
}
