var l="broadcast-sync",b="browser-message-broker";function u(e){return e.subsKey===l}function g(e){return e.senderId!=null&&e.targetId==null}function B(e){return e.senderId!=null&&e.targetId!=null}var n=Math.random().toString(36).substring(2,9);function f(e,t=1){let s;return(...a)=>{clearTimeout(s),s=setTimeout(()=>{e(...a)},t)}}var p=class{constructor(){if(this.trace=!1,this.senderId=n,this.state=new Map,this.subscribers=new Map,this.braodcasts=new Set,this.__bcChannel=new BroadcastChannel(b),globalThis.constructor.name==="Window"){let e=new CustomEvent("bmb-ready",{detail:this});globalThis.document.dispatchEvent(e)}this.__bcChannel.onmessage=this.handleBroadcast.bind(this),this.__bcChannel.onmessageerror=this.handleBroadcastError.bind(this),this.sendBrokerState=f(this.__sendBrokerState.bind(this),2),this.sendBrokerState()}handleBroadcastError(e){throw Error("BROADCAST FAILED: "+e.data)}__sendBrokerState(e,t){let s=Array.from(this.braodcasts.keys());t&&t.length>0&&(s=s.filter(r=>t.includes(r)));let a={};for(let r of this.state)!r[1]||!s.includes(r[0])||(a[r[0]]=r[1]);let i={id:n,availableState:a,broadcasts:s},o={subsKey:l,senderCtx:globalThis.constructor.name,senderId:n,targetId:e,msg:i};this.__bcChannel.postMessage(o),this.trace&&(e==null?console.log("[Broadcast sync requested]",o,this):console.log("[Broadcast sync responded]",e,o,this))}handleBroadcastSync(e){if(g(e))return this.sendBrokerState(e.senderId,e.msg.broadcasts);if(B(e))for(let t of Object.entries(e.msg.availableState))this.braodcasts.has(t[0])&&this.state.has(t[0])&&this.state.get(t[0])==null&&this.__notifySubscribers(t[0],t[1],e.senderId),this.trace&&console.log("[Broadcast sync responce handled]",e,this)}handleBroadcast(e){if(this.trace&&console.log("[Broadcast received]",e.data,this),e.data.targetId!=null&&e.data.targetId!==n){this.trace&&console.log("[Broadcast ignored]",e.data,this);return}if(u(e.data))return this.handleBroadcastSync(e.data);this.__notifySubscribers(e.data.subsKey,e.data.msg,e.data.senderId),this.trace&&console.log("[Broadcast handled]",e.data,this)}__configureBroadcast(e){if(!e.key)throw new Error("Invalid subscription");this.braodcasts.add(e.key);let t=e.dispose;e.dispose=()=>{t(),this.braodcasts.delete(e.key)},e.isBroadcast=!0,this.sendBrokerState()}GetState(e){if(e)return this.state.get(e)}async Publish(e,t,s){if(this.trace&&console.log("[Message published]",e,t,this),await this.__notifySubscribers(e,t,n),!this.braodcasts.has(e))return;let a={subsKey:e,senderCtx:globalThis.constructor.name,senderId:n,targetId:s,msg:t};this.__bcChannel.postMessage(a)}Subscribe(e,t,s=!1,a=!0){let i=this.subscribers.get(e)||[],o=t;i.push(o),this.subscribers.set(e,i);let r={key:e,isCached:!1,dispose:()=>{i.splice(i.indexOf(o),1),r.isDisposed=!0},publish:(c,h)=>this.Publish(e,c,h),isDisposed:!1};return s&&this.__configureBroadcast(r),a&&this.state.set(e,void 0),this.trace&&console.log("[Subscribe]",r,this),r}async __notifySubscribers(e,t,s){let a=this.subscribers.get(e)||[],i=[];for(let o of a)!o||(i.push(Promise.resolve(o(t,s))),this.trace&&console.log("[Handler called]",o,this));await Promise.all(i),this.state.has(e)&&this.state.set(e,t),this.trace&&console.log("[Message handled]",e,t,this)}};globalThis.BrowserMessageBroker=globalThis.BrowserMessageBroker||new p;var d=globalThis.BrowserMessageBroker;var S=d.Subscribe("testResp",void 0,!0),w=d.Subscribe("testReq",e=>{d.Publish("testResp",{payload:"response"})},!0);postMessage("ready");
//# sourceMappingURL=testWorker.js.map
