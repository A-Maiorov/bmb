// ../browser-message-broker/dist/Broker.js
var b = "broadcast-sync";
var f = "browser-message-broker";
function w(a) {
  return a.channelName === b;
}
function B(a) {
  return a.senderId != null && a.targetId == null;
}
function k(a) {
  return a.senderId != null && a.targetId != null;
}
var l = Math.random().toString(36).substring(2, 9);
function S(a, e = 1) {
  let s;
  return (...t) => {
    clearTimeout(s), s = setTimeout(() => {
      a(...t);
    }, e);
  };
}
var c = /* @__PURE__ */ new Map();
var g = class {
  constructor() {
    this.trace = false;
    this.senderId = l;
    this.state = /* @__PURE__ */ new Map();
    this.subscribers = /* @__PURE__ */ new Map();
    this.braodcasts = /* @__PURE__ */ new Set();
    this.__bcChannel = new BroadcastChannel(f);
    this.__nextMessageAwaters = /* @__PURE__ */ new Map();
    this.broadcastedRequests = /* @__PURE__ */ new Map();
    this.requestListeners = /* @__PURE__ */ new Map();
    if (globalThis.constructor.name === "Window") {
      let e = new CustomEvent("bmb-ready", { detail: this });
      globalThis.document.dispatchEvent(e);
    }
    this.__bcChannel.onmessage = this.handleBroadcast.bind(this), this.__bcChannel.onmessageerror = this.handleBroadcastError.bind(this), this.sendBrokerState = S(this.__sendBrokerState.bind(this), 2), this.sendBrokerState();
  }
  ConfigureChannel(e, s, t, n) {
    c.set(e, { enableBroadcast: s, enableCaching: t, trace: n }), t && this.state.set(e, void 0), s && this.braodcasts.add(e);
  }
  handleBroadcastError(e) {
    throw Error("BROADCAST FAILED: " + e.data);
  }
  __sendBrokerState(e, s) {
    let t = Array.from(this.braodcasts.keys());
    s && s.length > 0 && (t = t.filter((i) => s.includes(i)));
    let n = {};
    for (let i of this.state)
      !i[1] || !t.includes(i[0]) || (n[i[0]] = i[1]);
    let r = { id: l, availableState: n, broadcasts: t }, o = { channelName: b, senderCtx: globalThis.constructor.name, senderId: l, targetId: e, msg: r, channelType: "sync" };
    this.__bcChannel.postMessage(o), this.trace && (e == null ? console.log("[Broadcast sync requested]", o, this) : console.log("[Broadcast sync responded]", e, o, this));
  }
  handleBroadcastSync(e) {
    if (B(e))
      return this.sendBrokerState(e.senderId, e.msg.broadcasts);
    if (k(e))
      for (let s of Object.entries(e.msg.availableState))
        this.braodcasts.has(s[0]) && this.state.has(s[0]) && this.state.get(s[0]) == null && this.__notifySubscribers(s[0], s[1], e.senderId), this.trace && console.log("[Broadcast sync responce handled]", e, this);
  }
  handleBroadcast(e) {
    let s = this.trace || c.get(e.data.channelName)?.trace;
    if (s && console.log("[Broadcast received]", e.data, this), e.data.targetId != null && e.data.targetId !== l) {
      s && console.log("[Broadcast ignored]", e.data, this);
      return;
    }
    if (w(e.data))
      return this.handleBroadcastSync(e.data);
    switch (e.data.channelType) {
      case "pubSub":
        this.__notifySubscribers(e.data.channelName, e.data.msg, e.data.senderId);
        break;
      case "req":
        this.bridgeRequest(e.data.channelName, e.data.msg, e.data.senderId);
        break;
      case "rep":
        let t = this.broadcastedRequests.get(e.data.channelName);
        if (!t)
          return;
        t.resolve(e.data.msg), this.broadcastedRequests.delete(e.data.channelName);
        break;
    }
    s && console.log("[Broadcast handled]", e.data, this);
  }
  __configureBroadcast(e) {
    if (!e.channelName)
      throw new Error("Invalid subscription");
    this.braodcasts.add(e.channelName);
    let s = e.dispose;
    e.dispose = () => {
      s(), this.braodcasts.delete(e.channelName);
    }, e.isBroadcast = true, this.sendBrokerState();
  }
  GetState(e) {
    if (e)
      return this.state.get(e);
  }
  async Broadcast(e, s, t) {
    this._broadcast(e, s, "pubSub", t);
  }
  _broadcast(e, s, t, n) {
    let r = c.get(e);
    (this.trace || r?.trace) && console.log("[Message broadcasted]", e, s, this);
    let i = { channelName: e, senderCtx: globalThis.constructor.name, senderId: l, targetId: n, msg: s, channelType: t };
    r?.enableCaching && this.state.set(e, s), this.__bcChannel.postMessage(i);
  }
  async Publish(e, s, t) {
    (this.trace || c.get(e)?.trace) && console.log("[Message published]", e, s, this), await this.__notifySubscribers(e, s, l), this.braodcasts.has(e) && this._broadcast(e, s, "pubSub", t);
  }
  async nextMessage(e) {
    let s = this.__nextMessageAwaters.get(e);
    if (s)
      return s.promise;
    let t = { promise: void 0, resolve: void 0 };
    return t.promise = new Promise((n) => {
      t.resolve = n;
    }), this.__nextMessageAwaters.set(e, t), t.promise;
  }
  Subscribe(e, s, t = false, n = true) {
    let r = c.get(e), o = false;
    r && (t = r.enableBroadcast, n = r.enableCaching);
    let i = this.subscribers.get(e) || [], d = s;
    i.push(d), this.subscribers.set(e, i);
    let u = { channelName: e, isCached: false, dispose: () => {
      i.splice(i.indexOf(d), 1), u.isDisposed = true;
    }, publish: (h, p) => this.Publish(e, h, p), isDisposed: false };
    return t && this.__configureBroadcast(u), n && this.state.set(e, void 0), (this.trace || c.get(e)?.trace) && console.log(`[Subscribe${o ? ", preconfigured settings" : ""}]`, u, this), u;
  }
  bridgeRequest(e, s, t) {
    let n = this.requestListeners.get(e);
    return n ? n.handler(s, t) : Promise.resolve(void 0);
  }
  Request(e, s, t = false, n) {
    if (t) {
      this._broadcast(e, s, "req", n);
      let r = this.broadcastedRequests.get(e);
      r && r.resolve(void 0);
      let o, d = { promise: new Promise((u) => o = u), resolve: o };
      return this.broadcastedRequests.set(e, d), d.promise;
    } else {
      let r = this.requestListeners.get(e);
      return r ? r.handler(s) : Promise.resolve(void 0);
    }
  }
  Reply(e, s, t = false) {
    if (t) {
      let o = s;
      s = (i, d) => this._broadcast(e, o(i), "rep", d);
    }
    let n = { channelName: e, isDisposed: true, isBroadcast: t, handler: s, dispose: void 0 };
    n.dispose = () => {
      n.isDisposed = true, this.requestListeners.get(e) === n && this.requestListeners.delete(e);
    };
    let r = this.requestListeners.get(e);
    return r && (r.isDisposed = true, console.warn("Request listener replaced: " + e)), this.requestListeners.set(e, n), n;
  }
  async __notifySubscribers(e, s, t) {
    let n = this.subscribers.get(e) || [], r = this.trace || c.get(e)?.trace, o = [];
    for (let i of n)
      !i || (o.push(Promise.resolve(i(s, t))), r && console.log("[Handler called]", i, this));
    await Promise.all(o), this.state.has(e) && this.state.set(e, s), this.__handleAwaiter(e, s), r && console.log("[Message handled]", e, s, this);
  }
  __handleAwaiter(e, s) {
    let t = this.__nextMessageAwaters.get(e);
    !t || (t.resolve(s), this.__nextMessageAwaters.delete(e));
  }
};
globalThis.BrowserMessageBroker = globalThis.BrowserMessageBroker || new g();
var _ = globalThis.BrowserMessageBroker;

// suite/WebWorker/constants.ts
var PUB_SUB_REQUEST_SUBSCRIPTION_KEY = "testReq";
var PUB_SUB_RESPONSE_SUBSCRIPTION_KEY = "testResp";
var REQ_REP_CHANNEL_NAME = "reqRepChannel";

// suite/WebWorker/testWorker.ts
var pubSubChannelToWindow = _.Subscribe(PUB_SUB_RESPONSE_SUBSCRIPTION_KEY, void 0, true);
_.Subscribe(PUB_SUB_REQUEST_SUBSCRIPTION_KEY, (_2) => {
  pubSubChannelToWindow.publish({ payload: "response" });
}, true);
_.Reply(REQ_REP_CHANNEL_NAME, (req) => {
  return { payload: req.payload + "response" };
}, true);
postMessage("ready");
//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAic291cmNlcyI6IFsiLi4vLi4vLi4vYnJvd3Nlci1tZXNzYWdlLWJyb2tlci9zcmMvQnJva2VyLnRzIiwgImNvbnN0YW50cy50cyIsICJ0ZXN0V29ya2VyLnRzIl0sCiAgInNvdXJjZXNDb250ZW50IjogWyJpbXBvcnQge1xyXG4gIENoYW5uZWxUeXBlLFxyXG4gIElCcm9hZGNhc3RFbnZlbG9wZSxcclxuICBJQnJvYWRjYXN0U3luY0VudmVsb3BlLFxyXG4gIElCcm9rZXIsXHJcbiAgSUJyb2tlclN0YXRlLFxyXG4gIFJlcVN1YnNjcmlwdGlvbixcclxuICBTdWJzY3JpcHRpb24sXHJcbiAgVEhhbmRsZXIsXHJcbn0gZnJvbSBcIi4vVHlwZXNcIjtcclxuXHJcbmNvbnN0IEJST0FEQ0FTVF9TWU5DID0gXCJicm9hZGNhc3Qtc3luY1wiO1xyXG5jb25zdCBCUk9XU0VSX01FU1NBR0VfQlJPS0VSID0gXCJicm93c2VyLW1lc3NhZ2UtYnJva2VyXCI7XHJcblxyXG5mdW5jdGlvbiBpc0Jyb2FkY2FzdFN5bmMoZTogSUJyb2FkY2FzdEVudmVsb3BlKTogZSBpcyBJQnJvYWRjYXN0U3luY0VudmVsb3BlIHtcclxuICByZXR1cm4gZS5jaGFubmVsTmFtZSA9PT0gQlJPQURDQVNUX1NZTkM7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGlzU3luY1JlcShlOiBJQnJvYWRjYXN0RW52ZWxvcGUpIHtcclxuICByZXR1cm4gZS5zZW5kZXJJZCAhPSB1bmRlZmluZWQgJiYgZS50YXJnZXRJZCA9PSB1bmRlZmluZWQ7XHJcbn1cclxuZnVuY3Rpb24gaXNTeW5jUmVzcChlOiBJQnJvYWRjYXN0RW52ZWxvcGUpIHtcclxuICByZXR1cm4gZS5zZW5kZXJJZCAhPSB1bmRlZmluZWQgJiYgZS50YXJnZXRJZCAhPSB1bmRlZmluZWQ7XHJcbn1cclxuXHJcbmV4cG9ydCBjb25zdCBzZW5kZXJJZCA9IE1hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cmluZygyLCA5KTtcclxuXHJcbmZ1bmN0aW9uIGRlYm91bmNlPFQgZXh0ZW5kcyBGdW5jdGlvbj4oZnVuYzogVCwgdGltZW91dCA9IDEpIHtcclxuICBsZXQgdGltZXI6IG51bWJlcjtcclxuICByZXR1cm4gKC4uLmFyZ3M6IHVua25vd25bXSkgPT4ge1xyXG4gICAgY2xlYXJUaW1lb3V0KHRpbWVyKTtcclxuICAgIHRpbWVyID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgIGZ1bmMoLi4uYXJncyk7XHJcbiAgICB9LCB0aW1lb3V0KTtcclxuICB9O1xyXG59XHJcblxyXG5jb25zdCBjaGFubmVsU2V0dGluZ3MgPSBuZXcgTWFwPFxyXG4gIHN0cmluZyxcclxuICB7IGVuYWJsZUJyb2FkY2FzdDogYm9vbGVhbjsgZW5hYmxlQ2FjaGluZzogYm9vbGVhbjsgdHJhY2U6IGJvb2xlYW4gfVxyXG4+KCk7XHJcblxyXG5jbGFzcyBCcm9rZXIgaW1wbGVtZW50cyBJQnJva2VyIHtcclxuICB0cmFjZTogYm9vbGVhbiA9IGZhbHNlO1xyXG4gIHNlbmRlcklkID0gc2VuZGVySWQ7XHJcbiAgc3RhdGUgPSBuZXcgTWFwPHN0cmluZywgYW55PigpO1xyXG4gIHN1YnNjcmliZXJzID0gbmV3IE1hcDxzdHJpbmcsIFRIYW5kbGVyW10+KCk7XHJcbiAgYnJhb2RjYXN0cyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xyXG4gIHByaXZhdGUgX19iY0NoYW5uZWwgPSBuZXcgQnJvYWRjYXN0Q2hhbm5lbChCUk9XU0VSX01FU1NBR0VfQlJPS0VSKTtcclxuXHJcbiAgY29uc3RydWN0b3IoKSB7XHJcbiAgICBpZiAoZ2xvYmFsVGhpcy5jb25zdHJ1Y3Rvci5uYW1lID09PSBcIldpbmRvd1wiKSB7XHJcbiAgICAgIGNvbnN0IGV2ID0gbmV3IEN1c3RvbUV2ZW50KFwiYm1iLXJlYWR5XCIsIHsgZGV0YWlsOiB0aGlzIH0pO1xyXG4gICAgICBnbG9iYWxUaGlzLmRvY3VtZW50LmRpc3BhdGNoRXZlbnQoZXYpO1xyXG4gICAgfVxyXG4gICAgdGhpcy5fX2JjQ2hhbm5lbC5vbm1lc3NhZ2UgPSB0aGlzLmhhbmRsZUJyb2FkY2FzdC5iaW5kKHRoaXMpO1xyXG4gICAgdGhpcy5fX2JjQ2hhbm5lbC5vbm1lc3NhZ2VlcnJvciA9IHRoaXMuaGFuZGxlQnJvYWRjYXN0RXJyb3IuYmluZCh0aGlzKTtcclxuXHJcbiAgICB0aGlzLnNlbmRCcm9rZXJTdGF0ZSA9IGRlYm91bmNlKHRoaXMuX19zZW5kQnJva2VyU3RhdGUuYmluZCh0aGlzKSwgMik7XHJcblxyXG4gICAgdGhpcy5zZW5kQnJva2VyU3RhdGUoKTtcclxuICB9XHJcblxyXG4gIENvbmZpZ3VyZUNoYW5uZWwoXHJcbiAgICBjaGFubmVsTmFtZTogc3RyaW5nLFxyXG4gICAgZW5hYmxlQnJvYWRjYXN0OiBib29sZWFuLFxyXG4gICAgZW5hYmxlQ2FjaGluZzogYm9vbGVhbixcclxuICAgIHRyYWNlOiBib29sZWFuXHJcbiAgKTogdm9pZCB7XHJcbiAgICBjaGFubmVsU2V0dGluZ3Muc2V0KGNoYW5uZWxOYW1lLCB7IGVuYWJsZUJyb2FkY2FzdCwgZW5hYmxlQ2FjaGluZywgdHJhY2UgfSk7XHJcblxyXG4gICAgaWYgKGVuYWJsZUNhY2hpbmcpIHRoaXMuc3RhdGUuc2V0KGNoYW5uZWxOYW1lLCB1bmRlZmluZWQpO1xyXG4gICAgaWYgKGVuYWJsZUJyb2FkY2FzdCkgdGhpcy5icmFvZGNhc3RzLmFkZChjaGFubmVsTmFtZSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUJyb2FkY2FzdEVycm9yKGV2OiBNZXNzYWdlRXZlbnQ8SUJyb2FkY2FzdEVudmVsb3BlPikge1xyXG4gICAgdGhyb3cgRXJyb3IoXCJCUk9BRENBU1QgRkFJTEVEOiBcIiArIGV2LmRhdGEpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBzZW5kQnJva2VyU3RhdGU6IChcclxuICAgIHRhcmdldElkPzogc3RyaW5nLFxyXG4gICAgZmlsdGVyQnJvYWRjYXN0cz86IHN0cmluZ1tdXHJcbiAgKSA9PiB2b2lkO1xyXG4gIHByaXZhdGUgX19zZW5kQnJva2VyU3RhdGUodGFyZ2V0SWQ/OiBzdHJpbmcsIGZpbHRlckJyb2FkY2FzdHM/OiBzdHJpbmdbXSkge1xyXG4gICAgbGV0IGN1cnJlbnRCcm9hZGNhc3RzID0gQXJyYXkuZnJvbSh0aGlzLmJyYW9kY2FzdHMua2V5cygpKTtcclxuXHJcbiAgICBpZiAoZmlsdGVyQnJvYWRjYXN0cyAmJiBmaWx0ZXJCcm9hZGNhc3RzLmxlbmd0aCA+IDApIHtcclxuICAgICAgY3VycmVudEJyb2FkY2FzdHMgPSBjdXJyZW50QnJvYWRjYXN0cy5maWx0ZXIoKGspID0+XHJcbiAgICAgICAgZmlsdGVyQnJvYWRjYXN0cy5pbmNsdWRlcyhrKVxyXG4gICAgICApO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGF2YWlsYWJsZVN0YXRlOiB7IFt4OiBzdHJpbmddOiBhbnkgfSA9IHt9O1xyXG4gICAgZm9yIChjb25zdCB4IG9mIHRoaXMuc3RhdGUpIHtcclxuICAgICAgaWYgKCF4WzFdKSBjb250aW51ZTtcclxuICAgICAgaWYgKCFjdXJyZW50QnJvYWRjYXN0cy5pbmNsdWRlcyh4WzBdKSkgY29udGludWU7XHJcbiAgICAgIGF2YWlsYWJsZVN0YXRlW3hbMF1dID0geFsxXTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBzdGF0ZTogSUJyb2tlclN0YXRlID0ge1xyXG4gICAgICBpZDogc2VuZGVySWQsXHJcbiAgICAgIGF2YWlsYWJsZVN0YXRlLFxyXG4gICAgICBicm9hZGNhc3RzOiBjdXJyZW50QnJvYWRjYXN0cyxcclxuICAgIH07XHJcblxyXG4gICAgY29uc3QgZXY6IElCcm9hZGNhc3RTeW5jRW52ZWxvcGUgPSB7XHJcbiAgICAgIGNoYW5uZWxOYW1lOiBCUk9BRENBU1RfU1lOQyxcclxuICAgICAgc2VuZGVyQ3R4OiBnbG9iYWxUaGlzLmNvbnN0cnVjdG9yLm5hbWUsXHJcbiAgICAgIHNlbmRlcklkLFxyXG4gICAgICB0YXJnZXRJZCxcclxuICAgICAgbXNnOiBzdGF0ZSxcclxuICAgICAgY2hhbm5lbFR5cGU6IFwic3luY1wiLFxyXG4gICAgfTtcclxuXHJcbiAgICB0aGlzLl9fYmNDaGFubmVsLnBvc3RNZXNzYWdlKGV2KTtcclxuXHJcbiAgICBpZiAodGhpcy50cmFjZSlcclxuICAgICAgaWYgKHRhcmdldElkID09IHVuZGVmaW5lZClcclxuICAgICAgICBjb25zb2xlLmxvZyhcIltCcm9hZGNhc3Qgc3luYyByZXF1ZXN0ZWRdXCIsIGV2LCB0aGlzKTtcclxuICAgICAgZWxzZSBjb25zb2xlLmxvZyhcIltCcm9hZGNhc3Qgc3luYyByZXNwb25kZWRdXCIsIHRhcmdldElkLCBldiwgdGhpcyk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUJyb2FkY2FzdFN5bmMoZXY6IElCcm9hZGNhc3RTeW5jRW52ZWxvcGUpIHtcclxuICAgIGlmIChpc1N5bmNSZXEoZXYpKVxyXG4gICAgICByZXR1cm4gdGhpcy5zZW5kQnJva2VyU3RhdGUoZXYuc2VuZGVySWQsIGV2Lm1zZy5icm9hZGNhc3RzKTtcclxuICAgIGlmIChpc1N5bmNSZXNwKGV2KSkge1xyXG4gICAgICBmb3IgKGNvbnN0IHMgb2YgT2JqZWN0LmVudHJpZXMoZXYubXNnLmF2YWlsYWJsZVN0YXRlKSkge1xyXG4gICAgICAgIGlmIChcclxuICAgICAgICAgIHRoaXMuYnJhb2RjYXN0cy5oYXMoc1swXSkgJiZcclxuICAgICAgICAgIHRoaXMuc3RhdGUuaGFzKHNbMF0pICYmXHJcbiAgICAgICAgICB0aGlzLnN0YXRlLmdldChzWzBdKSA9PSB1bmRlZmluZWRcclxuICAgICAgICApIHtcclxuICAgICAgICAgIHRoaXMuX19ub3RpZnlTdWJzY3JpYmVycyhzWzBdLCBzWzFdLCBldi5zZW5kZXJJZCk7XHJcbiAgICAgICAgfVxyXG4gICAgICAgIGlmICh0aGlzLnRyYWNlKVxyXG4gICAgICAgICAgY29uc29sZS5sb2coXCJbQnJvYWRjYXN0IHN5bmMgcmVzcG9uY2UgaGFuZGxlZF1cIiwgZXYsIHRoaXMpO1xyXG4gICAgICB9XHJcbiAgICB9XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIGhhbmRsZUJyb2FkY2FzdChldjogTWVzc2FnZUV2ZW50PElCcm9hZGNhc3RFbnZlbG9wZT4pIHtcclxuICAgIGNvbnN0IHRyYWNlID0gdGhpcy50cmFjZSB8fCBjaGFubmVsU2V0dGluZ3MuZ2V0KGV2LmRhdGEuY2hhbm5lbE5hbWUpPy50cmFjZTtcclxuXHJcbiAgICBpZiAodHJhY2UpIGNvbnNvbGUubG9nKFwiW0Jyb2FkY2FzdCByZWNlaXZlZF1cIiwgZXYuZGF0YSwgdGhpcyk7XHJcblxyXG4gICAgaWYgKGV2LmRhdGEudGFyZ2V0SWQgIT0gdW5kZWZpbmVkICYmIGV2LmRhdGEudGFyZ2V0SWQgIT09IHNlbmRlcklkKSB7XHJcbiAgICAgIGlmICh0cmFjZSkgY29uc29sZS5sb2coXCJbQnJvYWRjYXN0IGlnbm9yZWRdXCIsIGV2LmRhdGEsIHRoaXMpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgaWYgKGlzQnJvYWRjYXN0U3luYyhldi5kYXRhKSkgcmV0dXJuIHRoaXMuaGFuZGxlQnJvYWRjYXN0U3luYyhldi5kYXRhKTtcclxuXHJcbiAgICBzd2l0Y2ggKGV2LmRhdGEuY2hhbm5lbFR5cGUpIHtcclxuICAgICAgY2FzZSBcInB1YlN1YlwiOlxyXG4gICAgICAgIHRoaXMuX19ub3RpZnlTdWJzY3JpYmVycyhcclxuICAgICAgICAgIGV2LmRhdGEuY2hhbm5lbE5hbWUsXHJcbiAgICAgICAgICBldi5kYXRhLm1zZyxcclxuICAgICAgICAgIGV2LmRhdGEuc2VuZGVySWRcclxuICAgICAgICApO1xyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgICBjYXNlIFwicmVxXCI6XHJcbiAgICAgICAgdGhpcy5icmlkZ2VSZXF1ZXN0KGV2LmRhdGEuY2hhbm5lbE5hbWUsIGV2LmRhdGEubXNnLCBldi5kYXRhLnNlbmRlcklkKTtcclxuICAgICAgICBicmVhaztcclxuICAgICAgY2FzZSBcInJlcFwiOlxyXG4gICAgICAgIGNvbnN0IHJlcSA9IHRoaXMuYnJvYWRjYXN0ZWRSZXF1ZXN0cy5nZXQoZXYuZGF0YS5jaGFubmVsTmFtZSk7XHJcbiAgICAgICAgaWYgKCFyZXEpIHJldHVybjtcclxuXHJcbiAgICAgICAgcmVxLnJlc29sdmUoZXYuZGF0YS5tc2cpO1xyXG4gICAgICAgIHRoaXMuYnJvYWRjYXN0ZWRSZXF1ZXN0cy5kZWxldGUoZXYuZGF0YS5jaGFubmVsTmFtZSk7XHJcblxyXG4gICAgICAgIGJyZWFrO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0cmFjZSkgY29uc29sZS5sb2coXCJbQnJvYWRjYXN0IGhhbmRsZWRdXCIsIGV2LmRhdGEsIHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogQnJpZGdlIHB1Yi9zdWIgbWVzc2FnZXMgdG8gYnJvYWRjYXN0IGNoYW5uZWxcclxuICAgKiBAcGFyYW0gc3Vic0tleVxyXG4gICAqIEByZXR1cm5zIHtTdWJzY3JpcHRpb259XHJcbiAgICovXHJcbiAgcHJpdmF0ZSBfX2NvbmZpZ3VyZUJyb2FkY2FzdChzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjxhbnk+KTogdm9pZCB7XHJcbiAgICBpZiAoIXN1YnNjcmlwdGlvbi5jaGFubmVsTmFtZSkge1xyXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3Vic2NyaXB0aW9uYCk7XHJcbiAgICB9XHJcbiAgICB0aGlzLmJyYW9kY2FzdHMuYWRkKHN1YnNjcmlwdGlvbi5jaGFubmVsTmFtZSk7XHJcbiAgICBjb25zdCBvcmlnaW5hbERpc3Bvc2UgPSBzdWJzY3JpcHRpb24uZGlzcG9zZTtcclxuICAgIHN1YnNjcmlwdGlvbi5kaXNwb3NlID0gKCkgPT4ge1xyXG4gICAgICBvcmlnaW5hbERpc3Bvc2UoKTtcclxuICAgICAgdGhpcy5icmFvZGNhc3RzLmRlbGV0ZShzdWJzY3JpcHRpb24uY2hhbm5lbE5hbWUpO1xyXG4gICAgfTtcclxuICAgIHN1YnNjcmlwdGlvbi5pc0Jyb2FkY2FzdCA9IHRydWU7XHJcblxyXG4gICAgdGhpcy5zZW5kQnJva2VyU3RhdGUoKTtcclxuICB9XHJcblxyXG4gIEdldFN0YXRlPFQ+KHN1YnNLZXk6IHN0cmluZyk6IFQgfCB1bmRlZmluZWQge1xyXG4gICAgaWYgKHN1YnNLZXkpIHtcclxuICAgICAgcmV0dXJuIHRoaXMuc3RhdGUuZ2V0KHN1YnNLZXkpIGFzIFQ7XHJcbiAgICB9IGVsc2Uge1xyXG4gICAgICByZXR1cm4gdW5kZWZpbmVkO1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgYXN5bmMgQnJvYWRjYXN0KGNoYW5uZWxOYW1lOiBzdHJpbmcsIG1zZzogdW5rbm93biwgdGFyZ2V0SWQ/OiBzdHJpbmcpIHtcclxuICAgIHRoaXMuX2Jyb2FkY2FzdChjaGFubmVsTmFtZSwgbXNnLCBcInB1YlN1YlwiLCB0YXJnZXRJZCk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIF9icm9hZGNhc3QoXHJcbiAgICBjaGFubmVsTmFtZTogc3RyaW5nLFxyXG4gICAgbXNnOiB1bmtub3duLFxyXG4gICAgY2hhbm5lbFR5cGU6IENoYW5uZWxUeXBlLFxyXG4gICAgdGFyZ2V0SWQ/OiBzdHJpbmdcclxuICApIHtcclxuICAgIGNvbnN0IHNldHRpbmdzID0gY2hhbm5lbFNldHRpbmdzLmdldChjaGFubmVsTmFtZSk7XHJcbiAgICBjb25zdCB0cmFjZSA9IHRoaXMudHJhY2UgfHwgc2V0dGluZ3M/LnRyYWNlO1xyXG4gICAgaWYgKHRyYWNlKSBjb25zb2xlLmxvZyhcIltNZXNzYWdlIGJyb2FkY2FzdGVkXVwiLCBjaGFubmVsTmFtZSwgbXNnLCB0aGlzKTtcclxuXHJcbiAgICBjb25zdCBlbnZlbG9wZTogSUJyb2FkY2FzdEVudmVsb3BlID0ge1xyXG4gICAgICBjaGFubmVsTmFtZTogY2hhbm5lbE5hbWUsXHJcbiAgICAgIHNlbmRlckN0eDogZ2xvYmFsVGhpcy5jb25zdHJ1Y3Rvci5uYW1lLFxyXG4gICAgICBzZW5kZXJJZDogc2VuZGVySWQsXHJcbiAgICAgIHRhcmdldElkOiB0YXJnZXRJZCxcclxuICAgICAgbXNnLFxyXG4gICAgICBjaGFubmVsVHlwZSxcclxuICAgIH07XHJcblxyXG4gICAgaWYgKHNldHRpbmdzPy5lbmFibGVDYWNoaW5nKSB0aGlzLnN0YXRlLnNldChjaGFubmVsTmFtZSwgbXNnKTtcclxuXHJcbiAgICB0aGlzLl9fYmNDaGFubmVsLnBvc3RNZXNzYWdlKGVudmVsb3BlKTtcclxuICB9XHJcblxyXG4gIGFzeW5jIFB1Ymxpc2goY2hhbm5lbE5hbWU6IHN0cmluZywgbXNnOiB1bmtub3duLCB0YXJnZXRJZD86IHN0cmluZykge1xyXG4gICAgY29uc3QgdHJhY2UgPSB0aGlzLnRyYWNlIHx8IGNoYW5uZWxTZXR0aW5ncy5nZXQoY2hhbm5lbE5hbWUpPy50cmFjZTtcclxuICAgIGlmICh0cmFjZSkgY29uc29sZS5sb2coXCJbTWVzc2FnZSBwdWJsaXNoZWRdXCIsIGNoYW5uZWxOYW1lLCBtc2csIHRoaXMpO1xyXG4gICAgYXdhaXQgdGhpcy5fX25vdGlmeVN1YnNjcmliZXJzKGNoYW5uZWxOYW1lLCBtc2csIHNlbmRlcklkKTtcclxuXHJcbiAgICBpZiAoIXRoaXMuYnJhb2RjYXN0cy5oYXMoY2hhbm5lbE5hbWUpKSByZXR1cm47XHJcblxyXG4gICAgdGhpcy5fYnJvYWRjYXN0KGNoYW5uZWxOYW1lLCBtc2csIFwicHViU3ViXCIsIHRhcmdldElkKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgX19uZXh0TWVzc2FnZUF3YXRlcnMgPSBuZXcgTWFwPFxyXG4gICAgc3RyaW5nLFxyXG4gICAgeyBwcm9taXNlOiBQcm9taXNlPHVua25vd24+OyByZXNvbHZlOiAobXNnOiB1bmtub3duKSA9PiB1bmtub3duIH1cclxuICA+KCk7XHJcblxyXG4gIGFzeW5jIG5leHRNZXNzYWdlPFQgPSB1bmtub3duPihzdWJzS2V5OiBzdHJpbmcpOiBQcm9taXNlPFQ+IHtcclxuICAgIGNvbnN0IGEgPSB0aGlzLl9fbmV4dE1lc3NhZ2VBd2F0ZXJzLmdldChzdWJzS2V5KTtcclxuICAgIGlmIChhKSByZXR1cm4gYS5wcm9taXNlIGFzIFByb21pc2U8VD47XHJcblxyXG4gICAgY29uc3QgbmV3QXdhaXRlcjoge1xyXG4gICAgICBwcm9taXNlOiBQcm9taXNlPHVua25vd24+O1xyXG4gICAgICByZXNvbHZlOiAobXNnOiB1bmtub3duKSA9PiB2b2lkO1xyXG4gICAgfSA9IHtcclxuICAgICAgcHJvbWlzZTogdW5kZWZpbmVkIGFzIHVua25vd24gYXMgUHJvbWlzZTxUPixcclxuICAgICAgcmVzb2x2ZTogdW5kZWZpbmVkIGFzIHVua25vd24gYXMgKG1zZzogdW5rbm93bikgPT4gdm9pZCxcclxuICAgIH07XHJcbiAgICBuZXdBd2FpdGVyLnByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzOiAobXNnOiB1bmtub3duKSA9PiB2b2lkKSA9PiB7XHJcbiAgICAgIG5ld0F3YWl0ZXIucmVzb2x2ZSA9IHJlcztcclxuICAgIH0pO1xyXG5cclxuICAgIHRoaXMuX19uZXh0TWVzc2FnZUF3YXRlcnMuc2V0KHN1YnNLZXksIG5ld0F3YWl0ZXIpO1xyXG5cclxuICAgIHJldHVybiBuZXdBd2FpdGVyLnByb21pc2UgYXMgUHJvbWlzZTxUPjtcclxuICB9XHJcblxyXG4gIFN1YnNjcmliZTxUPihcclxuICAgIGNoYW5uZWxOYW1lOiBzdHJpbmcsXHJcbiAgICBoYW5kbGVyPzogVEhhbmRsZXI8VD4sXHJcbiAgICBlbmFibGVCcm9hZGNhc3QgPSBmYWxzZSxcclxuICAgIGVuYWJsZUNhY2hpbmcgPSB0cnVlXHJcbiAgKTogU3Vic2NyaXB0aW9uPFQ+IHtcclxuICAgIGNvbnN0IHNldHRpbmdzID0gY2hhbm5lbFNldHRpbmdzLmdldChjaGFubmVsTmFtZSk7XHJcbiAgICBjb25zdCBzZXR0aW5nc092ZXJyaWRlbiA9IGZhbHNlO1xyXG4gICAgaWYgKHNldHRpbmdzKSB7XHJcbiAgICAgIGVuYWJsZUJyb2FkY2FzdCA9IHNldHRpbmdzLmVuYWJsZUJyb2FkY2FzdDtcclxuICAgICAgZW5hYmxlQ2FjaGluZyA9IHNldHRpbmdzLmVuYWJsZUNhY2hpbmc7XHJcbiAgICAgIHNldHRpbmdzT3ZlcnJpZGVuO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1YnMgPSB0aGlzLnN1YnNjcmliZXJzLmdldChjaGFubmVsTmFtZSkgfHwgW107XHJcbiAgICBjb25zdCBoZGwgPSBoYW5kbGVyIGFzIChtc2c6IHVua25vd24pID0+IHZvaWQ7XHJcbiAgICBzdWJzLnB1c2goaGRsKTtcclxuICAgIHRoaXMuc3Vic2NyaWJlcnMuc2V0KGNoYW5uZWxOYW1lLCBzdWJzKTtcclxuXHJcbiAgICBjb25zdCBzdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjxUPiA9IHtcclxuICAgICAgY2hhbm5lbE5hbWU6IGNoYW5uZWxOYW1lLFxyXG4gICAgICBpc0NhY2hlZDogZmFsc2UsXHJcbiAgICAgIGRpc3Bvc2U6ICgpID0+IHtcclxuICAgICAgICBzdWJzLnNwbGljZShzdWJzLmluZGV4T2YoaGRsKSwgMSk7XHJcbiAgICAgICAgc3Vic2NyaXB0aW9uLmlzRGlzcG9zZWQgPSB0cnVlO1xyXG4gICAgICB9LFxyXG4gICAgICBwdWJsaXNoOiAobXNnLCB0YXJnZXRJZD86IHN0cmluZykgPT5cclxuICAgICAgICB0aGlzLlB1Ymxpc2goY2hhbm5lbE5hbWUsIG1zZywgdGFyZ2V0SWQpLFxyXG4gICAgICBpc0Rpc3Bvc2VkOiBmYWxzZSxcclxuICAgIH07XHJcblxyXG4gICAgaWYgKGVuYWJsZUJyb2FkY2FzdCkgdGhpcy5fX2NvbmZpZ3VyZUJyb2FkY2FzdChzdWJzY3JpcHRpb24pO1xyXG4gICAgaWYgKGVuYWJsZUNhY2hpbmcpIHRoaXMuc3RhdGUuc2V0KGNoYW5uZWxOYW1lLCB1bmRlZmluZWQpO1xyXG5cclxuICAgIGlmICh0aGlzLnRyYWNlIHx8IGNoYW5uZWxTZXR0aW5ncy5nZXQoY2hhbm5lbE5hbWUpPy50cmFjZSkge1xyXG4gICAgICBjb25zdCBzZXR0aW5nc1N0YXR1cyA9IHNldHRpbmdzT3ZlcnJpZGVuXHJcbiAgICAgICAgPyBcIiwgcHJlY29uZmlndXJlZCBzZXR0aW5nc1wiXHJcbiAgICAgICAgOiBcIlwiO1xyXG4gICAgICBjb25zb2xlLmxvZyhgW1N1YnNjcmliZSR7c2V0dGluZ3NTdGF0dXN9XWAsIHN1YnNjcmlwdGlvbiwgdGhpcyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gc3Vic2NyaXB0aW9uO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBicmlkZ2VSZXF1ZXN0KFxyXG4gICAgY2hhbm5lbE5hbWU6IHN0cmluZyxcclxuICAgIHJlcXVlc3REYXRhOiB1bmtub3duLFxyXG4gICAgc2VuZGVySWQ6IHN0cmluZ1xyXG4gICkge1xyXG4gICAgY29uc3QgbGlzdGVuZXIgPSB0aGlzLnJlcXVlc3RMaXN0ZW5lcnMuZ2V0KGNoYW5uZWxOYW1lKTtcclxuICAgIGlmICghbGlzdGVuZXIpIHJldHVybiBQcm9taXNlLnJlc29sdmUodW5kZWZpbmVkKTtcclxuICAgIHJldHVybiBsaXN0ZW5lci5oYW5kbGVyKHJlcXVlc3REYXRhLCBzZW5kZXJJZCkgYXMgUHJvbWlzZTx1bmtub3duPjtcclxuICB9XHJcblxyXG4gIFJlcXVlc3Q8VFJlcCA9IHVua25vd24+KFxyXG4gICAgY2hhbm5lbE5hbWU6IHN0cmluZyxcclxuICAgIHJlcXVlc3REYXRhOiB1bmtub3duLFxyXG4gICAgZW5hYmxlQnJvYWRjYXN0ID0gZmFsc2UsXHJcbiAgICB0YXJnZXRJZD86IHN0cmluZ1xyXG4gICk6IFByb21pc2U8VFJlcD4gfCBQcm9taXNlPHVuZGVmaW5lZD4ge1xyXG4gICAgaWYgKCFlbmFibGVCcm9hZGNhc3QpIHtcclxuICAgICAgY29uc3QgbGlzdGVuZXIgPSB0aGlzLnJlcXVlc3RMaXN0ZW5lcnMuZ2V0KGNoYW5uZWxOYW1lKTtcclxuICAgICAgaWYgKCFsaXN0ZW5lcikgcmV0dXJuIFByb21pc2UucmVzb2x2ZSh1bmRlZmluZWQpO1xyXG4gICAgICByZXR1cm4gbGlzdGVuZXIuaGFuZGxlcihyZXF1ZXN0RGF0YSkgYXMgUHJvbWlzZTxUUmVwPjtcclxuICAgIH0gZWxzZSB7XHJcbiAgICAgIHRoaXMuX2Jyb2FkY2FzdChjaGFubmVsTmFtZSwgcmVxdWVzdERhdGEsIFwicmVxXCIsIHRhcmdldElkKTtcclxuICAgICAgY29uc3QgcmVxID0gdGhpcy5icm9hZGNhc3RlZFJlcXVlc3RzLmdldChjaGFubmVsTmFtZSk7XHJcbiAgICAgIGlmIChyZXEpIHJlcS5yZXNvbHZlKHVuZGVmaW5lZCk7XHJcblxyXG4gICAgICBsZXQgcmVzb2x2ZSA9IHVuZGVmaW5lZCBhcyB1bmtub3duIGFzIChyOiB1bmtub3duKSA9PiB2b2lkO1xyXG4gICAgICBjb25zdCBwcm9taXNlID0gbmV3IFByb21pc2U8VFJlcD4oXHJcbiAgICAgICAgKHJlcykgPT4gKHJlc29sdmUgPSByZXMgYXMgKHI6IHVua25vd24pID0+IHZvaWQpXHJcbiAgICAgICk7XHJcbiAgICAgIGNvbnN0IGJyZXEgPSB7XHJcbiAgICAgICAgcHJvbWlzZSxcclxuICAgICAgICByZXNvbHZlLFxyXG4gICAgICB9O1xyXG4gICAgICB0aGlzLmJyb2FkY2FzdGVkUmVxdWVzdHMuc2V0KGNoYW5uZWxOYW1lLCBicmVxKTtcclxuICAgICAgcmV0dXJuIGJyZXEucHJvbWlzZTtcclxuICAgIH1cclxuICB9XHJcbiAgcHJpdmF0ZSBicm9hZGNhc3RlZFJlcXVlc3RzID0gbmV3IE1hcDxcclxuICAgIHN0cmluZyxcclxuICAgIHsgcHJvbWlzZTogUHJvbWlzZTx1bmtub3duPjsgcmVzb2x2ZTogKHI6IHVua25vd24pID0+IHZvaWQgfVxyXG4gID4oKTtcclxuXHJcbiAgUmVwbHk8VFJlcSA9IHVua25vd24sIFRSZXAgPSB1bmtub3duPihcclxuICAgIGNoYW5uZWxOYW1lOiBzdHJpbmcsXHJcbiAgICBoYW5kbGVyOiAocmVxOiBUUmVxKSA9PiBUUmVwLFxyXG4gICAgZW5hYmxlQnJvYWRjYXN0ID0gZmFsc2VcclxuICApIHtcclxuICAgIGlmIChlbmFibGVCcm9hZGNhc3QpIHtcclxuICAgICAgY29uc3Qgb3JpZ0hhbmRsZXIgPSBoYW5kbGVyO1xyXG4gICAgICBoYW5kbGVyID0gKChtc2c6IFRSZXEsIHRhcmdldElkOiBzdHJpbmcpID0+XHJcbiAgICAgICAgdGhpcy5fYnJvYWRjYXN0KFxyXG4gICAgICAgICAgY2hhbm5lbE5hbWUsXHJcbiAgICAgICAgICBvcmlnSGFuZGxlcihtc2cpLFxyXG4gICAgICAgICAgXCJyZXBcIixcclxuICAgICAgICAgIHRhcmdldElkXHJcbiAgICAgICAgKSkgYXMgdW5rbm93biBhcyAocmVxOiBUUmVxKSA9PiBUUmVwO1xyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IHN1YnM6IFJlcVN1YnNjcmlwdGlvbiA9IHtcclxuICAgICAgY2hhbm5lbE5hbWUsXHJcbiAgICAgIGlzRGlzcG9zZWQ6IHRydWUsXHJcbiAgICAgIGlzQnJvYWRjYXN0OiBlbmFibGVCcm9hZGNhc3QsXHJcbiAgICAgIGhhbmRsZXI6IGhhbmRsZXIgYXMgKHI6IHVua25vd24pID0+IHVua25vd24sXHJcbiAgICAgIGRpc3Bvc2U6IHVuZGVmaW5lZCBhcyB1bmtub3duIGFzICgpID0+IHZvaWQsXHJcbiAgICB9O1xyXG5cclxuICAgIHN1YnMuZGlzcG9zZSA9ICgpID0+IHtcclxuICAgICAgc3Vicy5pc0Rpc3Bvc2VkID0gdHJ1ZTtcclxuICAgICAgY29uc3QgY3VycmVudExpc3RlbmVyID0gdGhpcy5yZXF1ZXN0TGlzdGVuZXJzLmdldChjaGFubmVsTmFtZSk7XHJcbiAgICAgIGlmIChjdXJyZW50TGlzdGVuZXIgPT09IHN1YnMpIHRoaXMucmVxdWVzdExpc3RlbmVycy5kZWxldGUoY2hhbm5lbE5hbWUpO1xyXG4gICAgfTtcclxuXHJcbiAgICBjb25zdCBjdXJyZW50TGlzdGVuZXIgPSB0aGlzLnJlcXVlc3RMaXN0ZW5lcnMuZ2V0KGNoYW5uZWxOYW1lKTtcclxuICAgIGlmIChjdXJyZW50TGlzdGVuZXIpIHtcclxuICAgICAgY3VycmVudExpc3RlbmVyLmlzRGlzcG9zZWQgPSB0cnVlO1xyXG4gICAgICBjb25zb2xlLndhcm4oXCJSZXF1ZXN0IGxpc3RlbmVyIHJlcGxhY2VkOiBcIiArIGNoYW5uZWxOYW1lKTtcclxuICAgIH1cclxuICAgIHRoaXMucmVxdWVzdExpc3RlbmVycy5zZXQoY2hhbm5lbE5hbWUsIHN1YnMpO1xyXG4gICAgcmV0dXJuIHN1YnM7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIHJlcXVlc3RMaXN0ZW5lcnMgPSBuZXcgTWFwPHN0cmluZywgUmVxU3Vic2NyaXB0aW9uPigpO1xyXG5cclxuICBwcml2YXRlIGFzeW5jIF9fbm90aWZ5U3Vic2NyaWJlcnMoXHJcbiAgICBjaGFubmVsTmFtZTogc3RyaW5nLFxyXG4gICAgbXNnOiB1bmtub3duLFxyXG4gICAgc0lkOiBzdHJpbmdcclxuICApIHtcclxuICAgIGNvbnN0IGhhbmRsZXJzID0gdGhpcy5zdWJzY3JpYmVycy5nZXQoY2hhbm5lbE5hbWUpIHx8IFtdO1xyXG4gICAgY29uc3QgdHJhY2UgPSB0aGlzLnRyYWNlIHx8IGNoYW5uZWxTZXR0aW5ncy5nZXQoY2hhbm5lbE5hbWUpPy50cmFjZTtcclxuICAgIGNvbnN0IGFsbFN1YnNjcmliZXJzUHJvbWlzZXM6IFByb21pc2U8dm9pZD5bXSA9IFtdO1xyXG4gICAgZm9yIChjb25zdCBoIG9mIGhhbmRsZXJzKSB7XHJcbiAgICAgIGlmICghaCkgY29udGludWU7XHJcbiAgICAgIGFsbFN1YnNjcmliZXJzUHJvbWlzZXMucHVzaChQcm9taXNlLnJlc29sdmUoaChtc2csIHNJZCkpKTtcclxuICAgICAgaWYgKHRyYWNlKSBjb25zb2xlLmxvZyhcIltIYW5kbGVyIGNhbGxlZF1cIiwgaCwgdGhpcyk7XHJcbiAgICB9XHJcblxyXG4gICAgYXdhaXQgUHJvbWlzZS5hbGwoYWxsU3Vic2NyaWJlcnNQcm9taXNlcyk7XHJcblxyXG4gICAgaWYgKHRoaXMuc3RhdGUuaGFzKGNoYW5uZWxOYW1lKSkgdGhpcy5zdGF0ZS5zZXQoY2hhbm5lbE5hbWUsIG1zZyk7XHJcblxyXG4gICAgdGhpcy5fX2hhbmRsZUF3YWl0ZXIoY2hhbm5lbE5hbWUsIG1zZyk7XHJcblxyXG4gICAgaWYgKHRyYWNlKSBjb25zb2xlLmxvZyhcIltNZXNzYWdlIGhhbmRsZWRdXCIsIGNoYW5uZWxOYW1lLCBtc2csIHRoaXMpO1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBfX2hhbmRsZUF3YWl0ZXIoc3Vic0tleTogc3RyaW5nLCBtc2c6IHVua25vd24pIHtcclxuICAgIGNvbnN0IGF3YWl0ZXIgPSB0aGlzLl9fbmV4dE1lc3NhZ2VBd2F0ZXJzLmdldChzdWJzS2V5KTtcclxuICAgIGlmICghYXdhaXRlcikgcmV0dXJuO1xyXG5cclxuICAgIGF3YWl0ZXIucmVzb2x2ZShtc2cpO1xyXG5cclxuICAgIHRoaXMuX19uZXh0TWVzc2FnZUF3YXRlcnMuZGVsZXRlKHN1YnNLZXkpO1xyXG4gIH1cclxufVxyXG5cclxuZ2xvYmFsVGhpcy5Ccm93c2VyTWVzc2FnZUJyb2tlciA9XHJcbiAgZ2xvYmFsVGhpcy5Ccm93c2VyTWVzc2FnZUJyb2tlciB8fCBuZXcgQnJva2VyKCk7XHJcblxyXG5leHBvcnQgY29uc3QgQk1CID0gZ2xvYmFsVGhpcy5Ccm93c2VyTWVzc2FnZUJyb2tlcjtcclxuZXhwb3J0IHR5cGUgeyBJQnJva2VyLCBTdWJzY3JpcHRpb24gfSBmcm9tIFwiLi9UeXBlc1wiO1xyXG4iLCAiZXhwb3J0IGNvbnN0IFBVQl9TVUJfUkVRVUVTVF9TVUJTQ1JJUFRJT05fS0VZID0gXCJ0ZXN0UmVxXCI7XHJcbmV4cG9ydCBjb25zdCBQVUJfU1VCX1JFU1BPTlNFX1NVQlNDUklQVElPTl9LRVkgPSBcInRlc3RSZXNwXCI7XHJcbmV4cG9ydCBjb25zdCBSRVFfUkVQX0NIQU5ORUxfTkFNRSA9IFwicmVxUmVwQ2hhbm5lbFwiO1xyXG4iLCAiaW1wb3J0IHsgQk1CIH0gZnJvbSBcImJyb3dzZXItbWVzc2FnZS1icm9rZXJcIjtcclxuaW1wb3J0IHtcclxuICBQVUJfU1VCX1JFUVVFU1RfU1VCU0NSSVBUSU9OX0tFWSxcclxuICBQVUJfU1VCX1JFU1BPTlNFX1NVQlNDUklQVElPTl9LRVksXHJcbiAgUkVRX1JFUF9DSEFOTkVMX05BTUUsXHJcbn0gZnJvbSBcIi4vY29uc3RhbnRzXCI7XHJcblxyXG5jb25zdCBwdWJTdWJDaGFubmVsVG9XaW5kb3cgPSBCTUIuU3Vic2NyaWJlKFxyXG4gIFBVQl9TVUJfUkVTUE9OU0VfU1VCU0NSSVBUSU9OX0tFWSxcclxuICB1bmRlZmluZWQsXHJcbiAgdHJ1ZVxyXG4pO1xyXG5cclxuQk1CLlN1YnNjcmliZShcclxuICBQVUJfU1VCX1JFUVVFU1RfU1VCU0NSSVBUSU9OX0tFWSxcclxuICAoXykgPT4ge1xyXG4gICAgcHViU3ViQ2hhbm5lbFRvV2luZG93LnB1Ymxpc2goeyBwYXlsb2FkOiBcInJlc3BvbnNlXCIgfSk7XHJcbiAgfSxcclxuICB0cnVlXHJcbik7XHJcblxyXG5CTUIuUmVwbHkoXHJcbiAgUkVRX1JFUF9DSEFOTkVMX05BTUUsXHJcbiAgKHJlcTogeyBwYXlsb2FkOiBzdHJpbmcgfSkgPT4ge1xyXG4gICAgcmV0dXJuIHsgcGF5bG9hZDogcmVxLnBheWxvYWQgKyBcInJlc3BvbnNlXCIgfTtcclxuICB9LFxyXG4gIHRydWVcclxuKTtcclxuXHJcbi8vbGV0IHdpbmRvdyBrbm93IHRoYXQgd29ya2VyIGlzIHJlYWR5IGFuZCBleGVjdXRlIHRlc3RcclxucG9zdE1lc3NhZ2UoXCJyZWFkeVwiKTtcclxuIl0sCiAgIm1hcHBpbmdzIjogIjtBQVdBLElBQU0sSUFBaUI7QUFBdkIsSUFDTSxJQUF5QjtBQUUvQixXQUF5QixHQUFvRDtBQUMzRSxTQUFPLEVBQUUsZ0JBQWdCO0FBQzNCO0FBRUEsV0FBbUIsR0FBdUI7QUFDeEMsU0FBTyxFQUFFLFlBQVksUUFBYSxFQUFFLFlBQVk7QUFDbEQ7QUFDQSxXQUFvQixHQUF1QjtBQUN6QyxTQUFPLEVBQUUsWUFBWSxRQUFhLEVBQUUsWUFBWTtBQUNsRDtBQUVPLElBQU0sSUFBVyxLQUFLLE9BQU8sRUFBRSxTQUFTLEVBQUUsRUFBRSxVQUFVLEdBQUcsQ0FBQztBQUVqRSxXQUFzQyxH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
