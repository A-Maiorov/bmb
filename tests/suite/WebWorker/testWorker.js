function h(s){return s.subsKey===d}function b(s){return s.senderId!=null&&s.targetId==null}function u(s){return s.senderId!=null&&s.targetId!=null}var o=Math.random().toString(36).substring(2,9),d="broadcast-sync",g="browser-message-broker";function B(s,t=1){let r;return(...a)=>{clearTimeout(r),r=setTimeout(()=>{s(...a)},t)}}var _=class{constructor(){if(this.senderId=o,this.state=new Map,this.subscribers=new Map,this.braodcasts=new Set,this.__bcChannel=new BroadcastChannel(g),globalThis.constructor.name==="Window"){let s=new CustomEvent("bmb-ready",{detail:this});globalThis.document.dispatchEvent(s)}this.__bcChannel.onmessage=this.handleBroadcast.bind(this),this.__bcChannel.onmessageerror=this.handleBroadcastError.bind(this),this.sendBrokerState=B(this.__sendBrokerState.bind(this),1),this.sendBrokerState()}handleBroadcastError(s){throw Error("BROADCAST FAILED: "+s.data)}__sendBrokerState(s,t){let r=Array.from(this.braodcasts.keys());t&&t.length>0&&(r=r.filter(e=>t.includes(e)));let a={};for(let e of this.state)!e[1]||!r.includes(e[0])||(a[e[0]]=e[1]);let i={msg:{id:o,availableState:a,broadcasts:r},subsKey:d,senderId:o,targetId:s};this.__bcChannel.postMessage(i)}handleBroadcastSync(s){if(b(s))return this.sendBrokerState(s.senderId,s.msg.broadcasts);if(u(s))for(let t of Object.entries(s.msg.availableState))this.braodcasts.has(t[0])&&this.state.get(t[0])==null&&this.__notifySubscribers(t[0],t[1],s.senderId)}handleBroadcast(s){if(console.log("BROADCAST RECEIVED: ",s.data),!(s.data.targetId!=null&&s.data.targetId!==o))return h(s.data)?this.handleBroadcastSync(s.data):this.__notifySubscribers(s.data.subsKey,s.data.msg,s.data.senderId)}__configureBroadcast(s){if(!s.key)throw new Error("Invalid subscription");this.braodcasts.add(s.key);let t=s.dispose;s.dispose=()=>{t(),this.braodcasts.delete(s.key)},s.isBroadcast=!0,this.sendBrokerState()}GetState(s){if(s)return this.state.get(s)}async Publish(s,t,r){if(await this.__notifySubscribers(s,t,o),!this.braodcasts.has(s))return;let a={msg:t,senderId:o,targetId:r,subsKey:s};this.__bcChannel.postMessage(a)}Subscribe(s,t,r=!1){let a=this.subscribers.get(s)||[],i=t;a.push(i),this.subscribers.set(s,a);let e={key:s,dispose:()=>{a.splice(a.indexOf(i),1),e.isDisposed=!0},enableBroadcast:()=>({}),publish:(l,c)=>this.Publish(s,l,c),isDisposed:!1};return e.enableBroadcast=()=>(this.__configureBroadcast(e),e),r&&this.__configureBroadcast(e),e}async __notifySubscribers(s,t,r){let a=this.subscribers.get(s)||[],i=[];for(let e of a)!e||i.push(Promise.resolve(e(t,r)));await Promise.all(i),n.state.set(s,t)}};globalThis.BrowserMessageBroker=globalThis.BrowserMessageBroker||new _;var n=globalThis.BrowserMessageBroker;var y=n.Subscribe("testResp").enableBroadcast(),m=n.Subscribe("testReq",s=>{n.Publish("testResp",{payload:"response"})}).enableBroadcast();postMessage("ready");
//# sourceMappingURL=testWorker.js.map
